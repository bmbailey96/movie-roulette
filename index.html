<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{ color-scheme: light dark;
    --bg:#0b0b0b; --card:#111; --fg:#f4f4f4; --muted:#9aa0a6; --border:#232323; --accent:#77ffa5; --accent2:#ff77c7;
    --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.45); }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 -apple-system,system-ui,Inter,Segoe UI,Roboto,sans-serif; }
  .wrap{ min-height:100%; display:flex; align-items:flex-start; justify-content:center; padding:max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
  .card{ width:100%; max-width:760px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }
  h1{ margin:0 0 8px; font-size:20px; letter-spacing:.2px; }
  .muted{ color:var(--muted); font-size:13px; }

  .controls{ position:sticky; top:0; background:linear-gradient(#111, #111cc); padding-top:6px; margin-top:-6px; z-index:5; }
  .bar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .bar button{ appearance:none; border:0; border-radius:14px; padding:14px 16px; font-weight:900; cursor:pointer; background:var(--accent); color:#05200f; font-size:16px; }
  .ghost{ background:#1b1b1b; color:var(--fg); border:1px solid #2a2a2a; }
  .count{ margin-left:auto; font-weight:600; padding:8px 12px; border:1px solid #222; border-radius:12px; color:#cfe; }

  .dial{ margin-top:10px; }
  .sliderrow{ display:flex; gap:10px; align-items:center; width:100%; }
  .sliderrow input[type="range"]{ flex:1 1 auto; appearance:none; height:10px; background:#161616; border:1px solid #2a2a2a; border-radius:999px;
    background-image:linear-gradient(90deg, rgba(119,255,165,.25) 0%, rgba(119,255,165,.25) 49%, #161616 49%, #161616 51%, rgba(255,119,199,.25) 51%, rgba(255,119,199,.25) 100%); }
  .sliderrow input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:28px; height:28px; margin-top:-10px; border-radius:50%; background:var(--accent); border:2px solid #083; box-shadow:0 1px 4px rgba(0,0,0,.35); }
  .ticks{ display:flex; justify-content:space-between; margin-top:4px; color:var(--muted); font-size:12px; }
  .mode{ margin-top:6px; font-size:13px; color:#c4cbd2; }
  .seg{ display:flex; background:#161616; border:1px solid #2a2a2a; border-radius:999px; overflow:hidden; }
  .seg button{ background:transparent; border:0; color:#cfe; padding:6px 10px; font-weight:800; font-size:13px; cursor:pointer; }
  .seg button.active{ background:#1f3327; color:#b6ffd1; }

  .poster{ width:100%; max-width:520px; margin:8px auto 12px; display:block; aspect-ratio:2/3; object-fit:cover; border-radius:14px; background:#181818; }
  .title{ font-size:26px; font-weight:900; margin:2px 0 2px; word-wrap:break-word; }
  .tagline-inline{ color:#c4cbd2; font-size:15px; margin:0 0 8px; }
  .meta{ color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chip{ font-size:12px; background:#1a1a1a; border:1px solid #2a2a2a; padding:4px 8px; border-radius:999px; color:#cfe; }

  .badges{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 10px; }
  .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#171717; color:#bfe; }

  .links{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .links a{ display:inline-block; padding:12px 14px; border-radius:12px; text-decoration:none; font-weight:900; font-size:15px; background:#1b1b1b; color:#c0ffd6; border:1px solid #2a2a2a; flex:1 1 220px; text-align:center; }

  #err{ margin-top:10px; color:#ffb3b3; white-space:pre-wrap; }
  .skeleton{ animation:pulse 1.2s infinite ease-in-out; background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%); background-size:400% 100%; }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}
</style>
</head>
<body>
<div class="wrap">
  <main class="card" role="main" id="root">
    <h1>ðŸŽ² Movie Roulette</h1>
    <div class="muted">Slide mood. Pick vibes. No repeats until the deck is spent.</div>

    <div class="controls">
      <div class="bar">
        <button id="deal">Deal</button>
        <button id="reroll" class="ghost" title="Another near this chaos">Re-roll nearby</button>
        <button id="double" class="ghost" title="Main + palette cleanser">Double feature</button>
        <div class="count muted">Deck: <span id="left">0</span> â€¢ Total: <span id="total">0</span></div>
      </div>

      <div class="dial" aria-label="order chaos control">
        <div class="sliderrow" style="margin-top:8px;">
          <span class="muted" style="width:56px;">Order</span>
          <input id="cha" type="range" min="0" max="100" step="1" value="50" />
          <span class="muted" style="width:56px; text-align:right;">Chaos</span>
        </div>
        <div class="ticks"><span>0</span><span>50</span><span>100</span></div>
        <div class="mode" id="modeText">Neutral â€¢ pure shuffle</div>

        <div class="seg" role="tablist" aria-label="variety" style="margin-top:8px;">
          <button id="varT" class="active" role="tab" aria-selected="true">Tight</button>
          <button id="varM" role="tab" aria-selected="false">Medium</button>
          <button id="varW" role="tab" aria-selected="false">Wide</button>
        </div>

        <div class="seg" role="tablist" aria-label="themes" style="margin-top:8px;">
          <button id="thAll" class="active">All</button>
          <button id="thWitch">Witchy</button>
          <button id="thBody">Body</button>
          <button id="thFolk">Folk</button>
          <button id="thFound">Found</button>
          <button id="thNeon">Neon</button>
        </div>

        <div class="seg" role="tablist" aria-label="content flags" style="margin-top:8px;">
          <button id="fNoGore">No gore</button>
          <button id="fNoSV">No sexual violence</button>
          <button id="fNoKids">No kids-in-peril</button>
        </div>
      </div>
    </div>

    <div id="err" role="alert" aria-live="polite"></div>

    <section id="result" style="display:none; margin-top:10px;">
      <img id="poster" class="poster skeleton" alt="Movie poster" crossorigin="anonymous" />
      <div class="title" id="title">Loadingâ€¦</div>
      <div class="tagline-inline" id="taglineInline" style="display:none;"></div>
      <div class="meta">
        <span id="year"></span>
        <span id="runChip" class="chip" style="display:none;"></span>
        <span id="chaosChip" class="chip" style="display:none;"></span>
      </div>
      <div class="badges" id="streamBadges" style="display:none;"></div>

      <details id="why" style="margin:6px 0 6px;">
        <summary style="cursor:pointer; color:#b6ffd1; font-weight:800;">Why this pick?</summary>
        <div class="muted" id="whyText" style="margin-top:6px;"></div>
      </details>

      <div class="links" id="linksRow"></div>
    </section>

    <section id="resultB" style="display:none; margin-top:18px; border-top:1px dashed #242424; padding-top:12px;">
      <div class="muted" style="margin-bottom:4px;">Palette Cleanser</div>
      <img id="posterB" class="poster skeleton" alt="Movie poster" crossorigin="anonymous" />
      <div class="title" id="titleB">Loadingâ€¦</div>
      <div class="tagline-inline" id="taglineInlineB" style="display:none;"></div>
      <div class="meta">
        <span id="yearB"></span>
        <span id="runChipB" class="chip" style="display:none;"></span>
        <span id="chaosChipB" class="chip" style="display:none;"></span>
      </div>
      <div class="badges" id="streamBadgesB" style="display:none;"></div>
      <div class="links" id="linksRowB"></div>
    </section>

    <p class="muted" style="margin-top:14px;">Tip: Add to Home Screen from Safariâ€™s share menu.</p>
    <p class="muted" style="margin-top:6px; font-size:12px;">This product uses the TMDb API but is not endorsed or certified by TMDb.</p>
  </main>
</div>

<script>
const MY_SERVICES = new Set(["Netflix","Amazon Prime Video","Hulu","Max","Paramount+","Apple TV+","Tubi TV"]);
const $ = s => document.querySelector(s);
const err = (m="") => { const e=$("#err"); e.textContent=m; e.style.display = m ? "block" : "none"; };

const TMDB_IMG_CDN = "https://image.tmdb.org/t/p";
const PLACEHOLDER_SVG = `data:image/svg+xml;utf8,` + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 900">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#181818"/>
        <stop offset="1" stop-color="#131313"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <text x="50%" y="50%" fill="#6a6a6a" font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif"
          font-size="36" text-anchor="middle" dominant-baseline="middle">NO POSTER</text>
  </svg>`);

// Accepts either a full URL or a TMDb /path
function posterURL(path, size="w500"){
  if (!path) return "";
  const p = String(path).trim();
  if (p.startsWith("http://") || p.startsWith("https://")) return p;  // full URL already
  const clean = p.startsWith("/") ? p : ("/" + p);
  return `${TMDB_IMG_CDN}/${size}${clean}`;
}
function setPosterImg(imgEl, posterPath, title){
  const url = posterURL(posterPath);
  imgEl.classList.add("skeleton");
  imgEl.src = url || PLACEHOLDER_SVG;
  imgEl.alt = title || "poster";
  imgEl.onload = () => imgEl.classList.remove("skeleton");
  imgEl.onerror = (e) => {
    console.warn("Poster failed, using placeholder:", {title, posterPath, url, err:e});
    imgEl.src = PLACEHOLDER_SVG;
    imgEl.classList.remove("skeleton");
  };
}

let MOVIES=[], DECK=[];
let CHAOS=50, VARIETY="T"; // Tight|Medium|Wide
let THEME="all";
let FILTERS={ noGore:false, noSV:false, noKids:false };
let lastPickIndex=null;

async function loadData(){
  try{
    const r = await fetch("./movies.json?v="+Date.now(), {cache:"no-store"});
    const txt = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,180)}`);
    MOVIES = JSON.parse(txt);
    $("#total").textContent = MOVIES.length;
    rebuildDeck();
  }catch(e){ err("Could not load movies.json.\n"+(e.message||e)); }
}

function providerMatchesMyServices(p){
  if (!p?.name) return false;
  const n = String(p.name).trim();
  if (MY_SERVICES.has(n)) return true;
  if (n === "HBO Max" && MY_SERVICES.has("Max")) return true;
  if (n === "Max" && MY_SERVICES.has("HBO Max")) return true;
  return false;
}
function availabilityNames(item){
  const prov = Array.isArray(item.providers) ? item.providers : [];
  const names=[]; const seen=new Set();
  for (const p of prov){
    if (providerMatchesMyServices(p)){
      const nm = String(p.name).trim();
      if (!seen.has(nm)){ seen.add(nm); names.push(nm); }
    }
  }
  return names;
}
function buildBadges(container, item){
  const names = availabilityNames(item);
  container.innerHTML = "";
  if (names.length){
    for (const n of names){
      const span = document.createElement("span");
      span.className="badge";
      span.textContent = n;
      container.appendChild(span);
    }
    container.style.display="";
  } else container.style.display="none";
}

function passesTheme(item){
  const f = item.flags || {};
  if (THEME==="all") return true;
  if (THEME==="witch") return f.theme_witchy;
  if (THEME==="body")  return f.theme_body_horror;
  if (THEME==="folk")  return f.theme_folk;
  if (THEME==="found") return f.theme_found_footage;
  if (THEME==="neon")  return f.theme_neon;
  return true;
}
function passesContentFlags(item){
  const f = item.flags || {};
  if (FILTERS.noGore && f.extreme_gore) return false;
  if (FILTERS.noSV && f.sexual_violence) return false;
  if (FILTERS.noKids && f.kids_in_peril) return false;
  return !item.unreleased_error; // hide unreleased
}

/* ---- Hard-banded deck around slider ---- */
function bandForVariety(){ return VARIETY==="T" ? 7 : VARIETY==="M" ? 15 : 30; }

function rebuildDeck(){
  if (!MOVIES.length) return;
  const target = CHAOS;
  const baseBand = bandForVariety();

  let band = baseBand;
  let candidates = MOVIES
    .map((m, i) => ({ m, i }))
    .filter(({m}) => passesTheme(m) && passesContentFlags(m) && Math.abs((m.chaos??50) - target) <= band);

  while (!candidates.length && band <= 50){
    band += 10;
    candidates = MOVIES.map((m,i)=>({m,i}))
      .filter(({m}) => passesTheme(m) && passesContentFlags(m) && Math.abs((m.chaos??50) - target) <= band);
  }
  if (!candidates.length){
    candidates = MOVIES.map((m,i)=>({m,i})).filter(({m}) => passesTheme(m) && passesContentFlags(m));
  }

  const deck = candidates.map(x=>x.i);
  const rnd = new Uint32Array(deck.length); crypto.getRandomValues(rnd);
  for (let i=deck.length-1;i>0;i--){ const j=rnd[i]%(i+1); [deck[i],deck[j]]=[deck[j],deck[i]]; }
  DECK = deck;
  $("#left").textContent = DECK.length;
}

/* ---- Render helpers ---- */
function setText(el, txt){ el.textContent = txt; }
function show(el, on){ el.style.display = on ? "" : "none"; }

function buildLinksRow(container, item){
  container.innerHTML = "";
  const lbBtn = document.createElement("a");
  lbBtn.textContent = "Open on Letterboxd";
  lbBtn.href = item.link || "#";
  lbBtn.target="_blank"; lbBtn.rel="noopener";
  container.appendChild(lbBtn);

  const names = availabilityNames(item);
  if (!names.length){
    const q = encodeURIComponent(`${item.title} full movie site:archive.org OR site:youtube.com OR torrent`);
    const searchBtn = document.createElement("a");
    searchBtn.textContent = "Search elsewhere";
    searchBtn.href = "https://www.google.com/search?q="+q;
    searchBtn.target="_blank"; searchBtn.rel="noopener";
    container.appendChild(searchBtn);
  }
}

function renderInto(prefix, item){
  const poster = document.getElementById(prefix==="A" ? "poster" : "posterB");
  setPosterImg(poster, item.poster, item.title);

  setText(document.getElementById(prefix==="A" ? "title" : "titleB"), item.title || "Untitled");

  const tag = (item.tagline||"").trim();
  const tagEl = document.getElementById(prefix==="A" ? "taglineInline" : "taglineInlineB");
  setText(tagEl, tag); show(tagEl, !!tag);

  const metaErr = item.unreleased_error ? ` â€” ${item.unreleased_error}` : "";
  const yearEl = document.getElementById(prefix==="A" ? "year" : "yearB");
  setText(yearEl, item.year ? `Year: ${item.year}${metaErr}` : metaErr);

  const run = item.runtime ? `${item.runtime} min${item.runtime<=80?" (blessed)":(item.runtime>=150?" (punishment)":"")}` : "";
  const runEl = document.getElementById(prefix==="A" ? "runChip" : "runChipB");
  setText(runEl, run); show(runEl, !!run);

  const chaos = typeof item.chaos==="number" ? item.chaos : null;
  const chipEl = document.getElementById(prefix==="A" ? "chaosChip" : "chaosChipB");
  if (chaos!==null){ setText(chipEl, `Chaos: ${chaos}`); show(chipEl, true);} else show(chipEl, false);

  const badges = document.getElementById(prefix==="A" ? "streamBadges" : "streamBadgesB");
  buildBadges(badges, item);

  if (prefix==="A"){
    const why = (item.chaos_reason || "").trim();
    const whyBox = document.getElementById("why");
    const whyText = document.getElementById("whyText");
    setText(whyText, why || "");
    whyBox.style.display = why ? "" : "none";
  }

  const links = document.getElementById(prefix==="A" ? "linksRow" : "linksRowB");
  buildLinksRow(links, item);
}

/* ---- Deal + Reroll + Double ---- */
function dealOne(fromIdx=null){
  err("");
  if (!MOVIES.length){ err("Data not loaded yet."); return; }

  let idx = fromIdx;
  if (idx==null){
    if (!DECK.length) rebuildDeck();
    idx = DECK.pop();
    $("#left").textContent = DECK.length;
  }
  lastPickIndex = idx;
  const item = MOVIES[idx];

  document.getElementById("result").style.display = "block";
  renderInto("A", item);
  document.getElementById("resultB").style.display = "none";
}

function neighborsAround(target, initial, max, step){
  for (let r=initial; r<=max; r+=step){
    const pool=[];
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const it = MOVIES[i];
      if (!passesTheme(it) || !passesContentFlags(it)) continue;
      const c = typeof it.chaos==="number" ? it.chaos : 50;
      if (Math.abs(c - target) <= r) pool.push(i);
    }
    if (pool.length) return pool;
  }
  return MOVIES.map((m,i)=>({m,i})).filter(({m})=>passesTheme(m)&&passesContentFlags(m)).map(x=>x.i);
}

function rerollNearby(){
  if (lastPickIndex==null){ dealOne(); return; }
  const curr = MOVIES[lastPickIndex];
  const c = typeof curr.chaos==="number" ? curr.chaos : 50;
  const pool = neighborsAround(c, 10, 40, 5);
  if (!pool.length){ err("No nearby picks with current filters."); return; }
  const idx = pool[Math.floor(Math.random()*pool.length)];
  dealOne(idx);
}

function doubleFeature(){
  if (lastPickIndex==null){ dealOne(); }
  const main = MOVIES[lastPickIndex];
  const mainChaos = typeof main.chaos==="number" ? main.chaos : 50;
  const target = Math.max(0, Math.min(100, 100 - mainChaos));

  let pool = neighborsAround(target, 12, 48, 6);
  if (!pool.length){
    let bestIdx = null, bestDist = -1;
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const it = MOVIES[i];
      if (!passesTheme(it) || !passesContentFlags(it)) continue;
      const d = Math.abs((it.chaos??50) - mainChaos);
      if (d > bestDist){ bestDist = d; bestIdx = i; }
    }
    if (bestIdx==null){ err("No suitable cleanser with current filters."); return; }
    pool = [bestIdx];
  }
  const idx = pool[Math.floor(Math.random()*pool.length)];
  const item = MOVIES[idx];

  document.getElementById("resultB").style.display = "block";
  renderInto("B", item);
}

/* ---- Wire up ---- */
$("#deal").addEventListener("click", ()=>dealOne());
$("#reroll").addEventListener("click", rerollNearby);
$("#double").addEventListener("click", doubleFeature);

const cha = $("#cha"), modeText = $("#modeText");
function updateModeLabel(v){
  if (v < 40)      modeText.textContent = "Order â€¢ bias toward low-chaos (newer/tame)";
  else if (v > 60) modeText.textContent = "Chaos â€¢ bias toward high-chaos (older/weird)";
  else             modeText.textContent = "Neutral â€¢ pure shuffle";
}
cha.addEventListener("input", (e)=>{ CHAOS = Number(e.target.value)||50; updateModeLabel(CHAOS); });
cha.addEventListener("change", ()=>{ rebuildDeck(); });

function setVar(which){
  VARIETY = which;
  $("#varT").classList.toggle("active", which==="T");
  $("#varM").classList.toggle("active", which==="M");
  $("#varW").classList.toggle("active", which==="W");
  rebuildDeck();
}
$("#varT").onclick = ()=>setVar("T");
$("#varM").onclick = ()=>setVar("M");
$("#varW").onclick = ()=>setVar("W");

function setTheme(which){
  THEME = which;
  $("#thAll").classList.toggle("active", which==="all");
  $("#thWitch").classList.toggle("active", which==="witch");
  $("#thBody").classList.toggle("active", which==="body");
  $("#thFolk").classList.toggle("active", which==="folk");
  $("#thFound").classList.toggle("active", which==="found");
  $("#thNeon").classList.toggle("active", which==="neon");
  rebuildDeck();
}
$("#thAll").onclick  = ()=>setTheme("all");
$("#thWitch").onclick= ()=>setTheme("witch");
$("#thBody").onclick = ()=>setTheme("body");
$("#thFolk").onclick = ()=>setTheme("folk");
$("#thFound").onclick= ()=>setTheme("found");
$("#thNeon").onclick = ()=>setTheme("neon");

function toggleFlag(btn, key){
  btn.classList.toggle("active");
  FILTERS[key] = btn.classList.contains("active");
  rebuildDeck();
}
$("#fNoGore").onclick = (e)=>toggleFlag(e.currentTarget, "noGore");
$("#fNoSV").onclick   = (e)=>toggleFlag(e.currentTarget, "noSV");
$("#fNoKids").onclick = (e)=>toggleFlag(e.currentTarget, "noKids");

loadData();
</script>
</body>
</html>
