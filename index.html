<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0b0b; --panel:#101010; --fg:#f4f4f4; --muted:#a7adb3; --border:#222;
    --accent:#77ffa5; --accentFg:#05200f; --ghost:#171717; --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --ok:#b6ffd1; --warn:#ffd36a; --bad:#ff8a8a;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg);
    font:16px/1.45 -apple-system, system-ui, Inter, Segoe UI, Roboto, sans-serif; }
  /* Full viewport layout, no scroll */
  .app{ height:100dvh; width:100%; display:grid; grid-template-rows:auto 1fr auto; gap:0; padding:env(safe-area-inset-top) env(safe-area-inset-right) calc(env(safe-area-inset-bottom)) env(safe-area-inset-left); overflow:hidden; }
  header{ display:flex; align-items:center; justify-content:space-between; padding:8px 12px 6px; }
  h1{ font-size:18px; margin:0; letter-spacing:.2px; }
  .sub{ color:var(--muted); font-size:12px; }

  /* Center stage: two cards side-by-side in landscape, stacked in portrait ‚Äî but clipped to viewport */
  .stage{ position:relative; display:grid; grid-template-columns:1fr; gap:10px; padding:8px 12px; overflow:hidden; }
  @media (orientation:landscape) and (min-width:700px){
    .stage{ grid-template-columns:1fr 0.9fr; }
  }
  .card{ height:100%; border:1px solid var(--border); border-radius:var(--radius); background:var(--panel); box-shadow:var(--shadow);
         display:grid; grid-template-rows:auto 1fr auto; overflow:hidden; min-height:0; }
  .cardHeader{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; gap:8px; border-bottom:1px solid #1a1a1a; }
  .titleWrap{ min-width:0; overflow:hidden; }
  .title{ font-size:17px; font-weight:900; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tagline{ color:#cfd6db; font-size:12px; margin:2px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta{ color:var(--muted); font-size:11px; display:flex; gap:6px; flex-wrap:wrap; }
  .chip{ font-size:11px; background:#151515; border:1px solid #262626; padding:3px 8px; border-radius:999px; color:#d8ffe8; }

  .cardBody{ position:relative; display:grid; grid-template-columns:110px 1fr; gap:10px; padding:10px; min-height:0; }
  @media (max-width:430px){ .cardBody{ grid-template-columns:96px 1fr; gap:8px; } }

  .posterWrap{ position:relative; }
  .poster{ display:block; width:100%; aspect-ratio:2/3; object-fit:cover; border-radius:12px; background:#121212; }
  .skeleton{ animation:pulse 1.2s infinite ease-in-out; background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%); background-size:400% 100%; }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}

  .info{ display:grid; grid-template-rows:1fr auto; min-height:0; }
  .why{ color:#b6ffd1; font-weight:800; font-size:12px; margin:0 0 6px; }
  .whyText{ color:var(--muted); font-size:12px; line-height:1.35; max-height:6.5em; overflow:hidden; text-overflow:ellipsis; }

  .badges{ display:flex; gap:6px; flex-wrap:wrap; align-self:end; }
  .badge{ font-size:10px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#171717; color:#cfe; }

  .links{ display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:8px 10px 10px; border-top:1px solid #1a1a1a; }
  .links a{ display:block; text-align:center; text-decoration:none; font-weight:900; font-size:14px; padding:10px 10px; border-radius:12px; border:1px solid #2a2a2a; background:#161616; color:#c0ffd6; }
  @media (max-width:430px){ .links{ grid-template-columns:1fr; } }

  /* Bottom control bar ‚Äî fixed height so nothing scrolls */
  .dock{ position:relative; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px 12px 12px; border-top:1px solid #1a1a1a; background:linear-gradient(#0d0d0d, #0d0d0de6); }
  .leftGroup{ display:flex; gap:8px; align-items:center; }
  .btn{ appearance:none; border:0; border-radius:14px; padding:12px 12px; font-weight:900; cursor:pointer; font-size:15px; }
  .btn.pri{ background:var(--accent); color:var(--accentFg); }
  .btn.gh{ background:var(--ghost); color:var(--fg); border:1px solid #2a2a2a; }

  /* Chaos segment (no slider) */
  .seg{ display:flex; background:#141414; border:1px solid #262626; border-radius:999px; overflow:hidden; }
  .seg button{ background:transparent; border:0; color:#d9fbe8; padding:8px 10px; font-weight:900; font-size:12px; cursor:pointer; }
  .seg button.active{ background:#1f3327; color:#b6ffd1; }
  .nudge{ display:flex; gap:6px; }
  .nud{ width:34px; height:34px; border-radius:10px; border:1px solid #262626; background:#141414; color:#b6ffd1; font-weight:900; font-size:16px; }

  .count{ justify-self:end; padding:6px 8px; border:1px solid #222; border-radius:10px; color:#cfe; font-size:12px; }

  /* Dialog */
  dialog{ border:1px solid var(--border); background:#0f0f0f; color:var(--fg); border-radius:16px; width:min(560px, 92vw); padding:14px; }
  dialog::backdrop{ background:rgba(0,0,0,.6); }
  .row{ display:flex; gap:8px; flex-wrap:wrap; }
  .pill{ background:#161616; border:1px solid #2a2a2a; border-radius:999px; padding:8px 10px; font-weight:800; font-size:13px; color:#d9fbe8; }
  .pill.active{ background:#242a24; color:#b6ffd1; }
  .seg2{ display:flex; background:#141414; border:1px solid #262626; border-radius:999px; overflow:hidden; }
  .seg2 button{ background:transparent; border:0; color:#d9fbe8; padding:8px 10px; font-weight:900; font-size:13px; cursor:pointer; }
  .seg2 button.active{ background:#1f3327; color:#b6ffd1; }

  #err{ color:var(--bad); white-space:pre-wrap; font-size:12px; padding:0 12px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>üé≤ Movie Roulette</h1>
      <div class="sub">Thumb-first. No scrolling. Mischief optional.</div>
    </div>
    <div class="count">Deck: <span id="left">0</span>/<span id="total">0</span></div>
  </header>

  <section class="stage" id="stage">
    <!-- MAIN PICK -->
    <article class="card" id="cardA" aria-label="Main pick">
      <div class="cardHeader">
        <div class="titleWrap">
          <h2 class="title" id="title">Loading‚Ä¶</h2>
          <p class="tagline" id="taglineInline" style="display:none;"></p>
          <div class="meta"><span id="year"></span><span id="runChip" class="chip" style="display:none;"></span><span id="chaosChip" class="chip" style="display:none;"></span></div>
        </div>
      </div>
      <div class="cardBody">
        <div class="posterWrap"><img id="poster" class="poster skeleton" referrerpolicy="no-referrer" alt="Poster"></div>
        <div class="info">
          <div>
            <p class="why" id="whyTitle" style="display:none;">Why this pick</p>
            <div class="whyText" id="whyText"></div>
          </div>
          <div class="badges" id="streamBadges" style="display:none;"></div>
        </div>
      </div>
      <div class="links" id="linksRow"></div>
    </article>

    <!-- DOUBLE FEATURE -->
    <article class="card" id="cardB" aria-label="Palette cleanser" style="display:none;">
      <div class="cardHeader">
        <div class="titleWrap">
          <h2 class="title" id="titleB">Loading‚Ä¶</h2>
          <p class="tagline" id="taglineInlineB" style="display:none;"></p>
          <div class="meta"><span id="yearB"></span><span id="runChipB" class="chip" style="display:none;"></span><span id="chaosChipB" class="chip" style="display:none;"></span></div>
        </div>
      </div>
      <div class="cardBody">
        <div class="posterWrap"><img id="posterB" class="poster skeleton" referrerpolicy="no-referrer" alt="Poster"></div>
        <div class="info">
          <div class="whyText sub">A calmer counterpoint (or a bigger dare) to your main pick. I‚Äôm trying to balance tone and chaos.</div>
          <div class="badges" id="streamBadgesB" style="display:none;"></div>
        </div>
      </div>
      <div class="links" id="linksRowB"></div>
    </article>
  </section>

  <div id="err" role="alert" aria-live="polite"></div>

  <!-- Bottom action dock -->
  <nav class="dock">
    <div class="leftGroup">
      <button id="deal" class="btn pri">Deal</button>
      <button id="reroll" class="btn gh">Re-roll</button>
      <button id="double" class="btn gh">Double</button>
    </div>

    <div class="seg" id="chaosSeg">
      <!-- five discrete modes -->
      <button data-chaos="15" id="c0">üßä Order</button>
      <button data-chaos="35" id="c1">üßÇ Lean</button>
      <button data-chaos="50" id="c2" class="active">‚öñÔ∏è Neutral</button>
      <button data-chaos="65" id="c3">üî• Lean</button>
      <button data-chaos="90" id="c4">üí• Chaos</button>
    </div>

    <div class="nudge">
      <button class="nud" id="minus">‚àí</button>
      <button class="nud" id="plus">Ôºã</button>
      <button class="btn gh" id="openFilters">Filters</button>
    </div>
  </nav>
</div>

<!-- Filters Dialog -->
<dialog id="filtersDlg">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
    <strong>Filters</strong><div class="sub" id="deckCountMini">Deck: 0</div>
  </div>

  <div class="row" style="margin-bottom:8px;">
    <div class="seg2">
      <button id="varT" class="active">Tight</button>
      <button id="varM">Medium</button>
      <button id="varW">Wide</button>
    </div>
    <button class="pill" id="resetAll">Reset</button>
  </div>

  <div class="row" style="margin-bottom:6px;">
    <div class="pill active" id="thAll">All</div>
    <div class="pill" id="thWitch">Witchy</div>
    <div class="pill" id="thBody">Body</div>
    <div class="pill" id="thFolk">Folk</div>
    <div class="pill" id="thFound">Found</div>
    <div class="pill" id="thNeon">Neon</div>
  </div>

  <div class="row" style="margin-bottom:6px;">
    <div class="pill" id="fNoGore">No gore</div>
    <div class="pill" id="fNoSV">No sexual violence</div>
    <div class="pill" id="fNoKids">No kids-in-peril</div>
  </div>

  <div class="row" style="justify-content:flex-end; margin-top:12px;">
    <button class="btn gh" id="closeFilters">Close</button>
  </div>
</dialog>

<script>
/* ---------- CONFIG ---------- */
const MY_SERVICES = new Set(["Netflix","Amazon Prime Video","Hulu","Max","Paramount+","Apple TV+","Tubi TV"]);
const TMDB_IMG = "https://image.tmdb.org/t/p";

/* ---------- UTIL ---------- */
const $ = s => document.querySelector(s);
const err = (m="") => { const e=$("#err"); e.textContent=m; e.style.display = m ? "block" : "none"; };

function posterURL(path, size="w500"){
  if (!path) return "";
  const s = String(path).trim();
  if (!s || s==="null" || s==="undefined") return "";
  if (s.startsWith("http://")) return s.replace("http://","https://");
  if (s.startsWith("https://")) return s;
  const clean = s.startsWith("/") ? s : "/"+s;
  return `${TMDB_IMG}/${size}${clean}`;
}
function setPoster(imgEl, posterPath, title){
  const sizes = ["w342","w500","w780","original"];
  let i = 0;
  function tryNext(){
    const u = posterURL(posterPath, sizes[i]);
    if (!u){ setFallback(); return; }
    imgEl.src = u;
  }
  function setFallback(){
    imgEl.src = `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 900"><rect width="100%" height="100%" fill="#141414"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#5a5a5a" font-family="system-ui, -apple-system, Segoe UI, Roboto" font-size="28">NO POSTER</text></svg>')}`;
  }
  imgEl.alt = title || "poster";
  imgEl.classList.add("skeleton");
  imgEl.onerror = () => { i++; if (i < sizes.length) tryNext(); else { setFallback(); imgEl.classList.remove("skeleton"); } };
  imgEl.onload = () => imgEl.classList.remove("skeleton");
  tryNext();
}

/* ---------- STATE ---------- */
let MOVIES=[], DECK=[];
let CHAOS=50;          // 0‚Äì100
let VARIETY="T";       // Tight / Medium / Wide
let THEME="all";
let FILTERS={ noGore:false, noSV:false, noKids:false };
let lastPickIndex=null;

/* ---------- LOAD DATA ---------- */
async function loadData(){
  try{
    const r = await fetch("./movies.json?v="+Date.now(), {cache:"no-store"});
    const txt = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,200)}`);
    const raw = JSON.parse(txt);
    MOVIES = raw.map(x => ({
      ...x,
      poster: x.poster || x.poster_path || "", // accept either
      chaos: (typeof x.chaos === "number") ? x.chaos
            : (x.Chaos!==undefined && x.Chaos!=="") ? Number(x.Chaos) : null
    }));
    $("#total").textContent = MOVIES.length;
    rebuildDeck();
  }catch(e){ err("Could not load movies.json.\n"+(e.message||e)); }
}

/* ---------- FILTER LOGIC ---------- */
function providerMatches(p){
  if (!p?.name) return false;
  const n = String(p.name).trim();
  if (MY_SERVICES.has(n)) return true;
  if (n==="HBO Max" && MY_SERVICES.has("Max")) return true;
  if (n==="Max" && MY_SERVICES.has("HBO Max")) return true;
  return false;
}
function availabilityNames(item){
  const prov = Array.isArray(item.providers) ? item.providers : [];
  const names=[]; const seen=new Set();
  for (const p of prov){ if (providerMatches(p)){ const nm = String(p.name).trim(); if (!seen.has(nm)){ seen.add(nm); names.push(nm); } } }
  return names;
}
function buildBadges(container, item){
  const names = availabilityNames(item);
  container.innerHTML = "";
  if (names.length){
    for (const n of names){ const s=document.createElement("span"); s.className="badge"; s.textContent=n; container.appendChild(s); }
    container.style.display="";
  } else container.style.display="none";
}
function passesTheme(item){
  const f = item.flags || {};
  if (THEME==="all") return true;
  if (THEME==="witch") return f.theme_witchy;
  if (THEME==="body")  return f.theme_body_horror;
  if (THEME==="folk")  return f.theme_folk;
  if (THEME==="found") return f.theme_found_footage;
  if (THEME==="neon")  return f.theme_neon;
  return true;
}
function passesContent(item){
  const f=item.flags||{};
  if (FILTERS.noGore && f.extreme_gore) return false;
  if (FILTERS.noSV && f.sexual_violence) return false;
  if (FILTERS.noKids && f.kids_in_peril) return false;
  return !item.unreleased_error;
}
function band(){ return VARIETY==="T"?7: VARIETY==="M"?15:30; }

/* ---------- DECK ---------- */
function rebuildDeck(){
  if (!MOVIES.length) return;
  const target = CHAOS;
  let b = band();
  let cands = MOVIES.map((m,i)=>({m,i}))
    .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);

  while (!cands.length && b <= 50){
    b+=10;
    cands = MOVIES.map((m,i)=>({m,i}))
      .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);
  }
  if (!cands.length){
    cands = MOVIES.map((m,i)=>({m,i})).filter(({m}) => passesTheme(m) && passesContent(m));
  }
  const deck = cands.map(x=>x.i);
  // shuffle
  const rnd = new Uint32Array(deck.length); crypto.getRandomValues(rnd);
  for (let i=deck.length-1;i>0;i--){ const j=rnd[i]%(i+1); [deck[i],deck[j]]=[deck[j],deck[i]]; }
  DECK=deck;
  $("#left").textContent = DECK.length;
  $("#deckCountMini").textContent = "Deck: " + DECK.length;
}

/* ---------- RENDER ---------- */
function setText(el, t){ el.textContent=t; }
function show(el, on){ el.style.display = on ? "" : "none"; }
function links(container, item){
  container.innerHTML = "";
  const lb=document.createElement("a");
  lb.textContent="Open on Letterboxd";
  lb.href=item.link||"#"; lb.target="_blank"; lb.rel="noopener";
  container.appendChild(lb);

  const names = availabilityNames(item);
  if (!names.length){
    const q=encodeURIComponent(`${item.title} full movie site:archive.org OR site:youtube.com OR torrent`);
    const s=document.createElement("a");
    s.textContent="Search elsewhere";
    s.href="https://www.google.com/search?q="+q; s.target="_blank"; s.rel="noopener";
    container.appendChild(s);
  } else {
    const s=document.createElement("a");
    s.textContent="Where to watch";
    s.href=`https://www.justwatch.com/us/search?q=${encodeURIComponent(item.title)}`;
    s.target="_blank"; s.rel="noopener";
    container.appendChild(s);
  }
}
function render(prefix,item){
  const p = document.getElementById(prefix==="A"?"poster":"posterB");
  setPoster(p, item.poster, item.title);

  const tId = prefix==="A"?"title":"titleB";
  setText(document.getElementById(tId), item.title||"Untitled");

  const tg=(item.tagline||"").trim();
  const tgId = prefix==="A"?"taglineInline":"taglineInlineB";
  setText(document.getElementById(tgId), tg); show(document.getElementById(tgId), !!tg);

  const metaErr = item.unreleased_error ? ` ‚Äî ${item.unreleased_error}` : "";
  const yId = prefix==="A"?"year":"yearB";
  setText(document.getElementById(yId), item.year ? `Year: ${item.year}${metaErr}` : metaErr);

  const run=item.runtime?`${item.runtime} min`:"";
  const rId = prefix==="A"?"runChip":"runChipB";
  setText(document.getElementById(rId), run); show(document.getElementById(rId), !!run);

  const c=item.chaos; const cId = prefix==="A"?"chaosChip":"chaosChipB";
  if (typeof c==="number"){ setText(document.getElementById(cId), `Chaos: ${c}`); show(document.getElementById(cId),true);} else show(document.getElementById(cId),false);

  const bEl=document.getElementById(prefix==="A"?"streamBadges":"streamBadgesB");
  buildBadges(bEl,item);

  if (prefix==="A"){
    const why=(item.chaos_reason||"").trim();
    const wTitle=$("#whyTitle"), wText=$("#whyText");
    setText(wText, why || "");
    show(wTitle, !!why); // keep compact; no details element, saves space
  }
  const lEl=document.getElementById(prefix==="A"?"linksRow":"linksRowB");
  links(lEl,item);
}

/* ---------- PICK LOGIC ---------- */
function dealOne(fromIdx=null){
  err("");
  if (!MOVIES.length){ err("Data not loaded yet."); return; }
  let idx=fromIdx;
  if (idx==null){ if (!DECK.length) rebuildDeck(); idx=DECK.pop(); $("#left").textContent=DECK.length; $("#deckCountMini").textContent="Deck: "+DECK.length; }
  lastPickIndex=idx;
  $("#cardA").style.display="grid";
  render("A", MOVIES[idx]);
  $("#cardB").style.display="none";
}
function neighbors(target,initial,max,step){
  for (let r=initial;r<=max;r+=step){
    const pool=[];
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const m=MOVIES[i]; if (!passesTheme(m) || !passesContent(m)) continue;
      const c=typeof m.chaos==="number"?m.chaos:50;
      if (Math.abs(c-target)<=r) pool.push(i);
    }
    if (pool.length) return pool;
  }
  return MOVIES.map((m,i)=>({m,i})).filter(({m})=>passesTheme(m)&&passesContent(m)).map(x=>x.i);
}
function rerollNearby(){
  if (lastPickIndex==null){ dealOne(); return; }
  const curr=MOVIES[lastPickIndex], c=typeof curr.chaos==="number"?curr.chaos:50;
  const pool=neighbors(c,10,40,5);
  if (!pool.length){ err("No nearby picks with current filters."); return; }
  dealOne(pool[Math.floor(Math.random()*pool.length)]);
}
function doubleFeature(){
  if (lastPickIndex==null){ dealOne(); }
  const main=MOVIES[lastPickIndex], mc=typeof main.chaos==="number"?main.chaos:50;
  const target=Math.max(0, Math.min(100, 100-mc));
  let pool=neighbors(target,12,48,6);
  if (!pool.length){
    let best=-1, idx=null;
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const m=MOVIES[i]; if (!passesTheme(m)||!passesContent(m)) continue;
      const d=Math.abs((m.chaos??50)-mc); if (d>best){ best=d; idx=i; }
    }
    if (idx==null){ err("No suitable cleanser with current filters."); return; }
    pool=[idx];
  }
  $("#cardB").style.display="grid";
  render("B", MOVIES[ pool[Math.floor(Math.random()*pool.length)] ]);
}

/* ---------- CHAOS CONTROL (SEGMENT + NUDGE) ---------- */
const seg=$("#chaosSeg");
seg.querySelectorAll("button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    seg.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    CHAOS = Number(btn.dataset.chaos)||50;
    rebuildDeck();
  });
});
$("#minus").onclick = ()=>{
  CHAOS = Math.max(0, CHAOS-3);
  // set nearest segment active
  const targets=[15,35,50,65,90]; let best=0,bd=1e9;
  targets.forEach((t,i)=>{ const d=Math.abs(t-CHAOS); if (d<bd){ bd=d; best=i; } });
  seg.querySelectorAll("button").forEach((b,i)=>b.classList.toggle("active", i===best));
  rebuildDeck();
};
$("#plus").onclick = ()=>{
  CHAOS = Math.min(100, CHAOS+3);
  const targets=[15,35,50,65,90]; let best=0,bd=1e9;
  targets.forEach((t,i)=>{ const d=Math.abs(t-CHAOS); if (d<bd){ bd=d; best=i; } });
  seg.querySelectorAll("button").forEach((b,i)=>b.classList.toggle("active", i===best));
  rebuildDeck();
};

/* ---------- FILTERS DIALOG ---------- */
const dlg=$("#filtersDlg");
$("#openFilters").onclick = ()=>dlg.showModal();
$("#closeFilters").onclick = ()=>dlg.close();
$("#resetAll").onclick = ()=>{
  VARIETY="T"; THEME="all"; FILTERS={noGore:false,noSV:false,noKids:false};
  ["varT","varM","varW"].forEach(id=>$("#"+id).classList.remove("active"));
  $("#varT").classList.add("active");
  ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  $("#thAll").classList.add("active");
  ["fNoGore","fNoSV","fNoKids"].forEach(id=>$("#"+id).classList.remove("active"));
  rebuildDeck(); dlg.close();
};
function setVar(w){ VARIETY=w; $("#varT").classList.toggle("active",w==="T"); $("#varM").classList.toggle("active",w==="M"); $("#varW").classList.toggle("active",w==="W"); rebuildDeck(); }
$("#varT").onclick=()=>setVar("T"); $("#varM").onclick=()=>setVar("M"); $("#varW").onclick=()=>setVar("W");
function setTheme(w){ THEME=w; ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  const map={all:"thAll",witch:"thWitch",body:"thBody",folk:"thFolk",found:"thFound",neon:"thNeon"}; $("#"+map[w]).classList.add("active"); rebuildDeck(); }
$("#thAll").onclick=()=>setTheme("all"); $("#thWitch").onclick=()=>setTheme("witch"); $("#thBody").onclick=()=>setTheme("body");
$("#thFolk").onclick=()=>setTheme("folk"); $("#thFound").onclick=()=>setTheme("found"); $("#thNeon").onclick=()=>setTheme("neon");

$("#fNoGore").onclick=()=>{ FILTERS.noGore=!FILTERS.noGore; $("#fNoGore").classList.toggle("active", FILTERS.noGore); rebuildDeck(); };
$("#fNoSV").onclick=()=>{ FILTERS.noSV=!FILTERS.noSV; $("#fNoSV").classList.toggle("active", FILTERS.noSV); rebuildDeck(); };
$("#fNoKids").onclick=()=>{ FILTERS.noKids=!FILTERS.noKids; $("#fNoKids").classList.toggle("active", FILTERS.noKids); rebuildDeck(); };

/* ---------- ACTIONS ---------- */
$("#deal").onclick = ()=>dealOne();
$("#reroll").onclick = rerollNearby;
$("#double").onclick = doubleFeature;

/* ---------- INIT ---------- */
loadData();
</script>
</body>
</html>
