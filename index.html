<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0b0b; --card:#111; --fg:#f4f4f4; --muted:#a2a7ad; --border:#242424;
    --accent:#77ffa5; --accentFg:#05200f; --ghost:#1b1b1b; --radius:16px;
    --shadow:0 10px 34px rgba(0,0,0,.45);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg);
    font:16px/1.5 -apple-system, system-ui, Inter, Segoe UI, Roboto, sans-serif; }
  .wrap{ min-height:100dvh; display:flex; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
  .card{ flex:1; max-width:760px; margin:auto; background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow); display:grid; grid-template-rows:auto auto 1fr auto; gap:12px; padding:14px; }

  h1{ margin:0; font-size:20px; letter-spacing:.2px; }
  .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

  /* Sticky control bar */
  .bar{
    position:sticky; top:0; z-index:5; padding-top:8px; margin-top:-8px;
    background:linear-gradient(#111, #111c);
    display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:center;
  }
  .btn{ appearance:none; border:0; border-radius:14px; padding:12px 12px; font-weight:900; cursor:pointer; font-size:15px; }
  .btn.pri{ background:var(--accent); color:var(--accentFg); }
  .btn.gh{ background:var(--ghost); color:var(--fg); border:1px solid #2a2a2a; }
  .count{ justify-self:end; padding:7px 10px; border:1px solid #222; border-radius:10px; color:#cfe; font-size:12px; }

  /* Slider */
  .dial{ display:grid; grid-template-columns:auto 1fr auto auto; gap:10px; align-items:center; }
  .lab{ color:var(--muted); font-size:12px; }
  input[type="range"]{ appearance:none; width:100%; height:10px; background:#161616; border:1px solid #2a2a2a; border-radius:999px;
    background-image:linear-gradient(90deg, rgba(119,255,165,.25) 0%, rgba(119,255,165,.25) 49%, #161616 49%, #161616 51%, rgba(255,119,199,.25) 51%, rgba(255,119,199,.25) 100%); }
  input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:26px; height:26px; margin-top:-9px; border-radius:50%; background:var(--accent); border:2px solid #083; }

  /* Result area */
  .grid{ display:grid; grid-template-columns:1fr; gap:8px; min-height:0; }
  .poster{ width:100%; max-width:520px; margin:2px auto 8px; display:block; aspect-ratio:2/3; object-fit:cover;
    border-radius:12px; background:#181818; max-height:65vh; }
  .title{ font-size:22px; font-weight:900; margin:0; }
  .tagline-inline{ color:#cfd6db; font-size:14px; margin:0; }
  .meta{ color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:12px; }
  .chip{ font-size:12px; background:#1a1a1a; border:1px solid #2a2a2a; padding:4px 8px; border-radius:999px; color:#cfe; }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; }
  .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#171717; color:#bfe; }
  details#why{ margin:4px 0 0; }
  details#why > summary{ list-style:none; cursor:pointer; color:#b6ffd1; font-weight:800; font-size:13px; }
  details#why > summary::-webkit-details-marker{ display:none; }
  .links{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:6px; }
  .links a{ display:block; padding:12px 10px; text-align:center; border-radius:12px; text-decoration:none; font-weight:900; font-size:14px; background:#1b1b1b; color:#c0ffd6; border:1px solid #2a2a2a; }

  #err{ color:#ffb3b3; white-space:pre-wrap; font-size:12px; }

  /* Filters modal */
  dialog{ border:1px solid var(--border); background:#0f0f0f; color:var(--fg); border-radius:16px; width:min(560px, 92vw); padding:14px; }
  dialog::backdrop{ background:rgba(0,0,0,.6); }
  .row{ display:flex; gap:8px; flex-wrap:wrap; }
  .seg{ display:flex; background:#161616; border:1px solid #2a2a2a; border-radius:999px; overflow:hidden; }
  .seg button{ background:transparent; border:0; color:#cfe; padding:8px 10px; font-weight:800; font-size:13px; cursor:pointer; }
  .seg button.active{ background:#1f3327; color:#b6ffd1; }
  .pill{ background:#161616; border:1px solid #2a2a2a; border-radius:999px; padding:8px 10px; font-weight:800; font-size:13px; }
  .pill.active{ background:#242a24; color:#b6ffd1; }

  .skeleton{ animation:pulse 1.2s infinite ease-in-out; background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%); background-size:400% 100%; }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}

  @media (max-width:430px){ .links{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <main class="card" role="main" id="root">
    <header>
      <h1>ðŸŽ² Movie Roulette</h1>
      <div class="sub">Slide mood. Pick vibes. No repeats.</div>
    </header>

    <div class="bar">
      <button id="deal" class="btn pri">Deal</button>
      <button id="reroll" class="btn gh">Re-roll</button>
      <button id="double" class="btn gh">Double</button>
      <button id="openFilters" class="btn gh">Filters</button>
      <div class="count">Deck: <span id="left">0</span> â€¢ <span id="total">0</span></div>
    </div>

    <div class="dial" aria-label="order chaos control">
      <div class="lab">Order</div>
      <input id="cha" type="range" min="0" max="100" step="1" value="50" aria-label="Chaos" />
      <div class="lab">Chaos</div>
      <div class="lab" id="modeText">Neutral</div>
    </div>

    <section id="result" style="display:none;">
      <div class="grid">
        <img id="poster" class="poster skeleton" alt="Movie poster"/>
        <div class="title" id="title">Loadingâ€¦</div>
        <p class="tagline-inline" id="taglineInline" style="display:none;"></p>

        <div class="meta">
          <span id="year"></span>
          <span id="runChip" class="chip" style="display:none;"></span>
          <span id="chaosChip" class="chip" style="display:none;"></span>
        </div>

        <div class="badges" id="streamBadges" style="display:none;"></div>

        <details id="why">
          <summary>Why this pick?</summary>
          <div class="sub" id="whyText" style="margin-top:6px;"></div>
        </details>

        <div class="links" id="linksRow"></div>
      </div>
    </section>

    <section id="resultB" style="display:none;">
      <div class="grid">
        <div class="sub">Palette Cleanser</div>
        <img id="posterB" class="poster skeleton" alt="Movie poster"/>
        <div class="title" id="titleB">Loadingâ€¦</div>
        <p class="tagline-inline" id="taglineInlineB" style="display:none;"></p>
        <div class="meta">
          <span id="yearB"></span>
          <span id="runChipB" class="chip" style="display:none;"></span>
          <span id="chaosChipB" class="chip" style="display:none;"></span>
        </div>
        <div class="badges" id="streamBadgesB" style="display:none;"></div>
        <div class="links" id="linksRowB"></div>
      </div>
    </section>

    <div id="err" role="alert" aria-live="polite"></div>

    <footer class="sub" style="margin-top:6px;">
      Tip: Add to Home Screen from Safariâ€™s share menu. â€¢ Uses TMDb but not endorsed.
    </footer>
  </main>
</div>

<!-- Filters modal -->
<dialog id="filtersDlg">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
    <strong>Filters</strong>
    <div class="sub" id="deckCountMini">Deck: 0</div>
  </div>

  <div class="row" style="margin-bottom:10px;">
    <div class="seg" role="tablist" aria-label="variety">
      <button id="varT" class="active" role="tab" aria-selected="true">Tight</button>
      <button id="varM" role="tab" aria-selected="false">Medium</button>
      <button id="varW" role="tab" aria-selected="false">Wide</button>
    </div>
    <button class="pill" id="resetAll">Reset</button>
  </div>

  <div class="row" style="margin-bottom:6px;">
    <div class="pill active" id="thAll">All</div>
    <div class="pill" id="thWitch">Witchy</div>
    <div class="pill" id="thBody">Body</div>
    <div class="pill" id="thFolk">Folk</div>
    <div class="pill" id="thFound">Found</div>
    <div class="pill" id="thNeon">Neon</div>
  </div>

  <div class="row" style="margin-bottom:6px;">
    <div class="pill" id="fNoGore">No gore</div>
    <div class="pill" id="fNoSV">No sexual violence</div>
    <div class="pill" id="fNoKids">No kids-in-peril</div>
  </div>

  <div class="row" style="justify-content:flex-end; margin-top:12px;">
    <button class="btn gh" id="closeFilters">Close</button>
  </div>
</dialog>

<script>
/* ====== Uses CSV-driven chaos/tags from movies.json (built by process.js) ====== */
const MY_SERVICES = new Set(["Netflix","Amazon Prime Video","Hulu","Max","Paramount+","Apple TV+","Tubi TV"]);
const $ = s => document.querySelector(s);
const err = (m="") => { const e=$("#err"); e.textContent=m; e.style.display = m ? "block" : "none"; };

const TMDB_IMG = "https://image.tmdb.org/t/p";

function posterURL(p, size="w500"){
  if (!p) return "";
  const s = String(p).trim();
  if (s.startsWith("http")) return s;
  const clean = s.startsWith("/") ? s : ("/"+s);
  return `${TMDB_IMG}/${size}${clean}`;
}
function setPoster(el, posterPath, title){
  const url = posterURL(posterPath);
  el.classList.add("skeleton");
  el.src = url || `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 900"><rect width="100%" height="100%" fill="#141414"/></svg>')}`;
  el.alt = title || "poster";
  el.onload = () => el.classList.remove("skeleton");
  el.onerror = () => { el.src = `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 900"><rect width="100%" height="100%" fill="#141414"/></svg>')}`; el.classList.remove("skeleton"); };
}

let MOVIES=[], DECK=[];
let CHAOS=50, VARIETY="T"; let THEME="all";
let FILTERS={ noGore:false, noSV:false, noKids:false };
let lastPickIndex=null;

async function loadData(){
  try{
    const r = await fetch("./movies.json?v="+Date.now(), {cache:"no-store"});
    const txt = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,180)}`);
    MOVIES = JSON.parse(txt).map(x => ({
      ...x,
      // accept either 'poster' or 'poster_path'
      poster: x.poster || x.poster_path || "",
      chaos: (typeof x.chaos === "number") ? x.chaos
            : (typeof x.Chaos === "number") ? x.Chaos
            : (x.Chaos ? Number(x.Chaos) : null),
    }));
    $("#total").textContent = MOVIES.length;
    rebuildDeck();
  }catch(e){ err("Could not load movies.json.\n"+(e.message||e)); }
}

function providerMatches(p){
  if (!p?.name) return false;
  const n = String(p.name).trim();
  if (MY_SERVICES.has(n)) return true;
  if (n === "HBO Max" && MY_SERVICES.has("Max")) return true;
  if (n === "Max" && MY_SERVICES.has("HBO Max")) return true;
  return false;
}
function availabilityNames(item){
  const prov = Array.isArray(item.providers) ? item.providers : [];
  const names=[]; const seen=new Set();
  for (const p of prov){ if (providerMatches(p)){ const nm = String(p.name).trim(); if (!seen.has(nm)){ seen.add(nm); names.push(nm); } } }
  return names;
}
function buildBadges(container, item){
  const names = availabilityNames(item);
  container.innerHTML = "";
  if (names.length){
    for (const n of names){ const s=document.createElement("span"); s.className="badge"; s.textContent=n; container.appendChild(s); }
    container.style.display="";
  } else container.style.display="none";
}

function passesTheme(item){
  const f = item.flags || {};
  if (THEME==="all") return true;
  if (THEME==="witch") return f.theme_witchy;
  if (THEME==="body")  return f.theme_body_horror;
  if (THEME==="folk")  return f.theme_folk;
  if (THEME==="found") return f.theme_found_footage;
  if (THEME==="neon")  return f.theme_neon;
  return true;
}
function passesContent(item){
  const f=item.flags||{};
  if (FILTERS.noGore && f.extreme_gore) return false;
  if (FILTERS.noSV && f.sexual_violence) return false;
  if (FILTERS.noKids && f.kids_in_peril) return false;
  return !item.unreleased_error;
}
function band(){ return VARIETY==="T"?7: VARIETY==="M"?15:30; }

function rebuildDeck(){
  if (!MOVIES.length) return;
  const target = CHAOS;
  let b = band();
  let cands = MOVIES.map((m,i)=>({m,i}))
    .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);

  while (!cands.length && b <= 50){
    b+=10;
    cands = MOVIES.map((m,i)=>({m,i}))
      .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);
  }
  if (!cands.length){
    cands = MOVIES.map((m,i)=>({m,i})).filter(({m}) => passesTheme(m) && passesContent(m));
  }
  const deck = cands.map(x=>x.i);
  const rnd = new Uint32Array(deck.length); crypto.getRandomValues(rnd);
  for (let i=deck.length-1;i>0;i--){ const j=rnd[i]%(i+1); [deck[i],deck[j]]=[deck[j],deck[i]]; }
  DECK=deck;
  $("#left").textContent = DECK.length;
  $("#deckCountMini").textContent = "Deck: " + DECK.length;
}

function setText(el, t){ el.textContent=t; }
function show(el, on){ el.style.display = on ? "" : "none"; }

function links(container, item){
  container.innerHTML = "";
  const lb=document.createElement("a");
  lb.textContent="Open on Letterboxd"; lb.href=item.link||"#"; lb.target="_blank"; lb.rel="noopener";
  container.appendChild(lb);

  const names = availabilityNames(item);
  if (!names.length){
    const q=encodeURIComponent(`${item.title} full movie site:archive.org OR site:youtube.com OR torrent`);
    const s=document.createElement("a");
    s.textContent="Search elsewhere"; s.href="https://www.google.com/search?q="+q; s.target="_blank"; s.rel="noopener";
    container.appendChild(s);
  }
}

function render(prefix,item){
  const p = document.getElementById(prefix==="A"?"poster":"posterB");
  setPoster(p, item.poster, item.title);

  setText(document.getElementById(prefix==="A"?"title":"titleB"), item.title||"Untitled");

  const tg=(item.tagline||"").trim(); const tEl=document.getElementById(prefix==="A"?"taglineInline":"taglineInlineB");
  setText(tEl, tg); show(tEl, !!tg);

  const metaErr = item.unreleased_error ? ` â€” ${item.unreleased_error}` : "";
  const yEl=document.getElementById(prefix==="A"?"year":"yearB");
  setText(yEl, item.year ? `Year: ${item.year}${metaErr}` : metaErr);

  const run=item.runtime?`${item.runtime} min`:"";
  const rEl=document.getElementById(prefix==="A"?"runChip":"runChipB");
  setText(rEl, run); show(rEl, !!run);

  const c=item.chaos; const cEl=document.getElementById(prefix==="A"?"chaosChip":"chaosChipB");
  if (typeof c==="number"){ setText(cEl, `Chaos: ${c}`); show(cEl,true);} else show(cEl,false);

  const bEl=document.getElementById(prefix==="A"?"streamBadges":"streamBadgesB");
  buildBadges(bEl,item);

  if (prefix==="A"){
    const why=(item.chaos_reason||"").trim();
    const wBox=$("#why"), wText=$("#whyText");
    setText(wText, why || "");
    wBox.style.display = why ? "" : "none";
  }
  const lEl=document.getElementById(prefix==="A"?"linksRow":"linksRowB");
  links(lEl,item);
}

function dealOne(fromIdx=null){
  err("");
  if (!MOVIES.length){ err("Data not loaded yet."); return; }
  let idx=fromIdx;
  if (idx==null){ if (!DECK.length) rebuildDeck(); idx=DECK.pop(); $("#left").textContent=DECK.length; $("#deckCountMini").textContent="Deck: "+DECK.length; }
  lastPickIndex=idx;
  $("#result").style.display="block";
  render("A", MOVIES[idx]);
  $("#resultB").style.display="none";
}
function neighbors(target,initial,max,step){
  for (let r=initial;r<=max;r+=step){
    const pool=[];
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const m=MOVIES[i]; if (!passesTheme(m) || !passesContent(m)) continue;
      const c=typeof m.chaos==="number"?m.chaos:50;
      if (Math.abs(c-target)<=r) pool.push(i);
    }
    if (pool.length) return pool;
  }
  return MOVIES.map((m,i)=>({m,i})).filter(({m})=>passesTheme(m)&&passesContent(m)).map(x=>x.i);
}
function rerollNearby(){
  if (lastPickIndex==null){ dealOne(); return; }
  const curr=MOVIES[lastPickIndex], c=typeof curr.chaos==="number"?curr.chaos:50;
  const pool=neighbors(c,10,40,5);
  if (!pool.length){ err("No nearby picks with current filters."); return; }
  dealOne(pool[Math.floor(Math.random()*pool.length)]);
}
function doubleFeature(){
  if (lastPickIndex==null){ dealOne(); }
  const main=MOVIES[lastPickIndex], mc=typeof main.chaos==="number"?main.chaos:50;
  const target=Math.max(0, Math.min(100, 100-mc));
  let pool=neighbors(target,12,48,6);
  if (!pool.length){
    let best=-1, idx=null;
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const m=MOVIES[i]; if (!passesTheme(m)||!passesContent(m)) continue;
      const d=Math.abs((m.chaos??50)-mc); if (d>best){ best=d; idx=i; }
    }
    if (idx==null){ err("No suitable cleanser with current filters."); return; }
    pool=[idx];
  }
  $("#resultB").style.display="block";
  render("B", MOVIES[ pool[Math.floor(Math.random()*pool.length)] ]);
}

/* Wire up */
$("#deal").onclick = ()=>dealOne();
$("#reroll").onclick = rerollNearby;
$("#double").onclick = doubleFeature;

const cha=$("#cha"), modeText=$("#modeText");
function mode(v){ if (v<40) return "Order"; if (v>60) return "Chaos"; return "Neutral"; }
cha.addEventListener("input",(e)=>{ CHAOS=Number(e.target.value)||50; modeText.textContent=mode(CHAOS); });
cha.addEventListener("change", ()=>rebuildDeck());

/* Filters modal */
const dlg=$("#filtersDlg");
$("#openFilters").onclick = ()=>dlg.showModal();
$("#closeFilters").onclick = ()=>dlg.close();
$("#resetAll").onclick = ()=>{
  VARIETY="T"; THEME="all"; FILTERS={noGore:false,noSV:false,noKids:false};
  ["varT","varM","varW"].forEach(id=>$("#"+id).classList.remove("active"));
  $("#varT").classList.add("active");
  ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  $("#thAll").classList.add("active");
  ["fNoGore","fNoSV","fNoKids"].forEach(id=>$("#"+id).classList.remove("active"));
  rebuildDeck(); dlg.close();
};
function setVar(w){ VARIETY=w; $("#varT").classList.toggle("active",w==="T"); $("#varM").classList.toggle("active",w==="M"); $("#varW").classList.toggle("active",w==="W"); rebuildDeck(); }
$("#varT").onclick=()=>setVar("T"); $("#varM").onclick=()=>setVar("M"); $("#varW").onclick=()=>setVar("W");
function setTheme(w){ THEME=w; ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  const map={all:"thAll",witch:"thWitch",body:"thBody",folk:"thFolk",found:"thFound",neon:"thNeon"}; $("#"+map[w]).classList.add("active"); rebuildDeck(); }
$("#thAll").onclick=()=>setTheme("all"); $("#thWitch").onclick=()=>setTheme("witch"); $("#thBody").onclick=()=>setTheme("body");
$("#thFolk").onclick=()=>setTheme("folk"); $("#thFound").onclick=()=>setTheme("found"); $("#thNeon").onclick=()=>setTheme("neon");
function togglePill(id,key){ const el=$("#"+id); el.classList.toggle("active"); FILTERS[key]=el.classList.contains("active"); rebuildDeck(); }
$("#fNoGore").onclick=()=>togglePill("fNoGore","noGore");
$("#fNoSV").onclick=()=>togglePill("fNoSV","noSV");
$("#fNoKids").onclick=()=>togglePill("fNoKids","noKids");

loadData();
</script>
</body>
</html>
