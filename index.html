<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0b0b; --card:#111; --fg:#f4f4f4; --muted:#9aa0a6; --border:#232323; --accent:#77ffa5; --accent2:#ff77c7;
    --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.45);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 -apple-system, system-ui, Inter, Segoe UI, Roboto, sans-serif; }
  .wrap{ min-height:100%; display:flex; align-items:flex-start; justify-content:center; padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
  .card{ width:100%; max-width:760px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }

  h1{ margin:0 0 8px; font-size:20px; letter-spacing:.2px; }
  .muted{ color:var(--muted); font-size:13px; }

  .controls{ position:sticky; top:0; background:linear-gradient(#111, #111cc); padding-top:6px; margin-top:-6px; z-index:5; }
  .bar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .bar button{
    appearance:none; border:0; border-radius:14px; padding:14px 16px; font-weight:900; cursor:pointer;
    background:var(--accent); color:#05200f; font-size:16px;
  }
  .ghost{ background:#1b1b1b; color:var(--fg); border:1px solid #2a2a2a; }
  .count{ margin-left:auto; font-weight:600; padding:8px 12px; border:1px solid #222; border-radius:12px; color:#cfe; }

  .dial{ margin-top:10px; }
  .sliderrow{ display:flex; gap:10px; align-items:center; width:100%; }
  .sliderrow input[type="range"]{
    flex:1 1 auto; appearance:none; height:10px; background:#161616; border:1px solid #2a2a2a; border-radius:999px;
    background-image: linear-gradient(90deg,
      rgba(119,255,165,.25) 0%, rgba(119,255,165,.25) 49%,
      #161616 49%, #161616 51%,
      rgba(255,119,199,.25) 51%, rgba(255,119,199,.25) 100%);
  }
  .sliderrow input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:28px; height:28px; margin-top:-10px; border-radius:50%;
    background:var(--accent); border:2px solid #083; box-shadow:0 1px 4px rgba(0,0,0,.35);
  }
  .ticks{ display:flex; justify-content:space-between; margin-top:4px; color:var(--muted); font-size:12px; }
  .mode{ margin-top:6px; font-size:13px; color:#c4cbd2; }

  .seg{ display:flex; background:#161616; border:1px solid #2a2a2a; border-radius:999px; overflow:hidden; }
  .seg button{
    background:transparent; border:0; color:#cfe; padding:6px 10px; font-weight:800; font-size:13px; cursor:pointer;
  }
  .seg button.active{ background:#1f3327; color:#b6ffd1; }

  .poster{ width:100%; max-width:520px; margin:8px auto 12px; display:block; aspect-ratio:2/3; object-fit:cover; border-radius:14px; background:#181818; }
  .title{ font-size:26px; font-weight:900; margin:2px 0 2px; word-wrap:break-word; }
  .tagline-inline{ color:#c4cbd2; font-size:15px; margin:0 0 8px; }
  .meta{ color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chip{ font-size:12px; background:#1a1a1a; border:1px solid #2a2a2a; padding:4px 8px; border-radius:999px; color:#cfe; }

  .badges{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 10px; }
  .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#171717; color:#bfe; }

  .links{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .links a{
    display:inline-block; padding:12px 14px; border-radius:12px; text-decoration:none; font-weight:900; font-size:15px;
    background:#1b1b1b; color:#c0ffd6; border:1px solid #2a2a2a; flex:1 1 220px; text-align:center;
  }

  #err{ margin-top:10px; color:#ffb3b3; white-space:pre-wrap; }
  .skeleton{ animation: pulse 1.2s infinite ease-in-out; background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%); background-size:400% 100%; }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}

  .hist{ margin-top:14px; background:#121212; border:1px solid #222; border-radius:12px; padding:10px; }
  .hist svg{ width:100%; height:80px; display:block; }
  .hist .labels{ display:flex; justify-content:space-between; font-size:11px; color:#9aa0a6; margin-top:4px; }
</style>
</head>
<body>
<div class="wrap">
  <main class="card" role="main" id="root">
    <h1>ðŸŽ² Movie Roulette</h1>
    <div class="muted">Slide mood. Pick vibes. No repeats until the deck is spent.</div>

    <div class="controls">
      <div class="bar">
        <button id="deal">Deal</button>
        <button id="reroll" class="ghost" title="Another near this chaos">Re-roll nearby</button>
        <button id="double" class="ghost" title="Main + palette cleanser">Double feature</button>
        <div class="count muted">Deck: <span id="left">0</span> â€¢ Total: <span id="total">0</span></div>
      </div>

      <div class="dial" aria-label="order chaos control">
        <div class="sliderrow" style="margin-top:8px;">
          <span class="muted" style="width:56px;">Order</span>
          <input id="cha" type="range" min="0" max="100" step="1" value="50" />
          <span class="muted" style="width:56px; text-align:right;">Chaos</span>
        </div>
        <div class="ticks"><span>0</span><span>50</span><span>100</span></div>
        <div class="mode" id="modeText">Neutral â€¢ pure shuffle</div>

        <div class="seg" role="tablist" aria-label="variety" style="margin-top:8px;">
          <button id="varT" class="active" role="tab" aria-selected="true">Tight</button>
          <button id="varM" role="tab" aria-selected="false">Medium</button>
          <button id="varW" role="tab" aria-selected="false">Wide</button>
        </div>

        <div class="seg" role="tablist" aria-label="theme nights" style="margin-top:8px;">
          <button id="thAll" class="active">All</button>
          <button id="thWitch">Witchy</button>
          <button id="thBody">Body</button>
          <button id="thFolk">Folk</button>
          <button id="thFound">Found</button>
          <button id="thNeon">Neon</button>
        </div>

        <div class="seg" role="tablist" aria-label="content flags" style="margin-top:8px;">
          <button id="fNoGore" class="">No gore</button>
          <button id="fNoSV" class="">No sexual violence</button>
          <button id="fNoKids" class="">No kids-in-peril</button>
        </div>
      </div>
    </div>

    <div id="err" role="alert" aria-live="polite"></div>

    <section id="result" style="display:none; margin-top:10px;">
      <img id="poster" class="poster skeleton" alt="Movie poster" />
      <div class="title" id="title">Loadingâ€¦</div>
      <div class="tagline-inline" id="taglineInline" style="display:none;"></div>
      <div class="meta">
        <span id="year"></span>
        <span id="runChip" class="chip" style="display:none;"></span>
        <span id="chaosChip" class="chip" style="display:none;"></span>
      </div>
      <div class="badges" id="streamBadges" style="display:none;"></div>

      <details id="why" style="margin:6px 0 6px;">
        <summary style="cursor:pointer; color:#b6ffd1; font-weight:800;">Why this pick?</summary>
        <div class="muted" id="whyText" style="margin-top:6px;"></div>
      </details>

      <div class="links" id="linksRow"></div>
    </section>

    <section id="resultB" style="display:none; margin-top:18px; border-top:1px dashed #242424; padding-top:12px;">
      <div class="muted" style="margin-bottom:4px;">Palette Cleanser</div>
      <img id="posterB" class="poster skeleton" alt="Movie poster" />
      <div class="title" id="titleB">Loadingâ€¦</div>
      <div class="tagline-inline" id="taglineInlineB" style="display:none;"></div>
      <div class="meta">
        <span id="yearB"></span>
        <span id="runChipB" class="chip" style="display:none;"></span>
        <span id="chaosChipB" class="chip" style="display:none;"></span>
      </div>
      <div class="badges" id="streamBadgesB" style="display:none;"></div>
      <div class="links" id="linksRowB"></div>
    </section>

    <div class="hist" id="histBox" style="display:none;">
      <div class="muted">Chaos spread</div>
      <svg id="hist"></svg>
      <div class="labels"><span>0</span><span>50</span><span>100</span></div>
    </div>

    <p class="muted" style="margin-top:14px;">Tip: Add to Home Screen from Safariâ€™s share menu for full-screen app mode.</p>
    <p class="muted" style="margin-top:6px; font-size:12px;">This product uses the TMDb API but is not endorsed or certified by TMDb.</p>
  </main>
</div>

<script>
/* --- Services you actually have --- */
const MY_SERVICES = new Set(["Netflix","Amazon Prime Video","Hulu","Max","Paramount+","Apple TV+","Tubi TV"]);

const $ = s => document.querySelector(s);
const TMDB_IMG = (path, size="w500") => path ? `https://image.tmdb.org/t/p/${size}${path}` : "";
const err = (m="") => { const e=$("#err"); e.textContent=m; e.style.display = m ? "block" : "none"; };

let MOVIES=[], DECK=[];
let CHAOS=50, VARIETY="T";             // Tight|Medium|Wide
let THEME="all";                       // all|witch|body|folk|found|neon
let FILTERS={ noGore:false, noSV:false, noKids:false };
let lastPickIndex=null;

/* ---- Data load ---- */
async function loadData(){
  try{
    const r = await fetch("./movies.json?v="+Date.now(), {cache:"no-store"});
    const txt = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,180)}`);
    MOVIES = JSON.parse(txt);
    $("#total").textContent = MOVIES.length;
    buildHistogram();
    rebuildDeck();
  }catch(e){ err("Could not load movies.json.\n"+(e.message||e)); }
}

/* ---- Providers / streaming badges ---- */
function providerMatchesMyServices(p){
  if (!p?.name) return false;
  const n = String(p.name).trim();
  if (MY_SERVICES.has(n)) return true;
  if (n === "HBO Max" && MY_SERVICES.has("Max")) return true;
  if (n === "Max" && MY_SERVICES.has("HBO Max")) return true;
  return false;
}
function availabilityBuckets(item){
  const prov = Array.isArray(item.providers) ? item.providers : [];
  const res = { myNames:[] }; const seen = new Set();
  for (const p of prov){
    if (providerMatchesMyServices(p)){
      const nm = String(p.name).trim();
      if (!seen.has(nm)){ seen.add(nm); res.myNames.push(nm); }
    }
  }
  return res;
}
function buildBadges(container, item){
  const b = availabilityBuckets(item);
  container.innerHTML = "";
  if (b.myNames.length){
    for (const name of b.myNames){
      const span = document.createElement("span");
      span.className="badge";
      span.textContent = name;
      container.appendChild(span);
    }
    container.style.display="";
  } else container.style.display="none";
}

/* ---- Filters ---- */
function passesTheme(item){
  const f = item.flags || {};
  if (THEME==="all") return true;
  if (THEME==="witch") return f.theme_witchy;
  if (THEME==="body")  return f.theme_body_horror;
  if (THEME==="folk")  return f.theme_folk;
  if (THEME==="found") return f.theme_found_footage;
  if (THEME==="neon")  return f.theme_neon;
  return true;
}
function passesContentFlags(item){
  const f = item.flags || {};
  if (FILTERS.noGore && f.extreme_gore) return false;
  if (FILTERS.noSV && f.sexual_violence) return false;
  if (FILTERS.noKids && f.kids_in_peril) return false;
  return !item.unreleased_error; // hide unreleased
}

/* ---- Deck building ---- */
function gaussianWeight(x, mu, sigma){ const d=x-mu; return Math.exp(-(d*d)/(2*sigma*sigma)); }
function sigmaForVariety(){ return VARIETY==="T" ? 10 : VARIETY==="M" ? 18 : 30; }

function rebuildDeck(){
  if (!MOVIES.length) return;
  const target = CHAOS, sigma = sigmaForVariety();
  const bucket = [];

  for (let i=0;i<MOVIES.length;i++){
    const it = MOVIES[i];
    if (!passesTheme(it) || !passesContentFlags(it)) continue;

    const chaos = typeof it.chaos==="number" ? it.chaos : 50;
    let weight = 1 + 2.2*gaussianWeight(chaos, target, sigma);
    weight = Math.max(0.2, Math.min(3.0, weight));
    const times = Math.max(1, Math.min(10, Math.round(weight * 3)));
    for (let t=0;t<times;t++) bucket.push(i);
  }

  if (!bucket.length){ for (let i=0;i<MOVIES.length;i++) bucket.push(i); }

  const rnd = new Uint32Array(bucket.length); crypto.getRandomValues(rnd);
  for (let i=bucket.length-1;i>0;i--){ const j=rnd[i]%(i+1); [bucket[i],bucket[j]]=[bucket[j],bucket[i]]; }

  const seen=new Set(), deck=[];
  for (const idx of bucket){ if(!seen.has(idx)){ seen.add(idx); deck.push(idx); } }
  DECK = deck;
  $("#left").textContent = DECK.length;
}

/* ---- Render helpers ---- */
function setText(el, txt){ el.textContent = txt; }
function show(el, on){ el.style.display = on ? "" : "none"; }
function posterLoad(el){ el.classList.add("skeleton"); el.onload = el.onerror = ()=> el.classList.remove("skeleton"); }
function runtimeLabel(min){
  if (!min) return "";
  const s = `${min} min`;
  if (min<=80) return `${s} (blessed)`;
  if (min>=150) return `${s} (punishment)`;
  return s;
}
function buildLinksRow(container, item){
  container.innerHTML = "";
  const lbBtn = document.createElement("a");
  lbBtn.textContent = "Open on Letterboxd";
  lbBtn.href = item.link || "#";
  lbBtn.target="_blank"; lbBtn.rel="noopener";
  container.appendChild(lbBtn);

  // If not on your services, add "Search elsewhere" (archive/youtube/torrent hint)
  const b = availabilityBuckets(item);
  if (!b.myNames.length){
    const q = encodeURIComponent(`${item.title} full movie site:archive.org OR site:youtube.com OR torrent`);
    const searchBtn = document.createElement("a");
    searchBtn.textContent = "Search elsewhere";
    searchBtn.href = "https://www.google.com/search?q="+q;
    searchBtn.target="_blank"; searchBtn.rel="noopener";
    container.appendChild(searchBtn);
  }
}

/* ---- Deal + Reroll ---- */
function dealOne(fromIdx=null){
  err("");
  if (!MOVIES.length){ err("Data not loaded yet."); return; }

  let idx = fromIdx;
  if (idx==null){
    if (!DECK.length) rebuildDeck();
    idx = DECK.pop();
    $("#left").textContent = DECK.length;
  }
  lastPickIndex = idx;

  const item = MOVIES[idx];

  // main card
  $("#result").style.display = "block";
  const poster = $("#poster");
  poster.src = item.poster ? TMDB_IMG(item.poster, "w500") : "";
  poster.alt = item.title || "poster"; posterLoad(poster);

  setText($("#title"), item.title || "Untitled");
  const tag = (item.tagline||"").trim();
  setText($("#taglineInline"), tag); show($("#taglineInline"), !!tag);

  const metaErr = item.unreleased_error ? ` â€” ${item.unreleased_error}` : "";
  setText($("#year"), item.year ? `Year: ${item.year}${metaErr}` : metaErr);
  const runText = runtimeLabel(item.runtime);
  setText($("#runChip"), runText); show($("#runChip"), !!runText);

  const chaos = typeof item.chaos==="number" ? item.chaos : null;
  const chip = $("#chaosChip"); if (chaos!==null){ setText(chip, `Chaos: ${chaos}`); show(chip, true);} else show(chip, false);

  buildBadges($("#streamBadges"), item);

  const why = (item.chaos_reason || "").trim();
  const whyBox = $("#why");
  setText($("#whyText"), why || "");
  whyBox.style.display = why ? "" : "none";

  buildLinksRow($("#linksRow"), item);

  drawHistogramMarker(chaos, CHAOS);

  // clear cleanser
  $("#resultB").style.display = "none";
}

function neighborsAroundChaos(target, initial=10, max=35, step=5){
  // widen window until we have candidates
  for (let radius=initial; radius<=max; radius+=step){
    const pool=[];
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const it = MOVIES[i];
      if (!passesTheme(it) || !passesContentFlags(it)) continue;
      const c = typeof it.chaos==="number" ? it.chaos : 50;
      if (Math.abs(c - target) <= radius) pool.push(i);
    }
    if (pool.length) return pool;
  }
  // final fallback: return *all* valid indices
  const all=[];
  for (let i=0;i<MOVIES.length;i++){
    if (i===lastPickIndex) continue;
    const it = MOVIES[i];
    if (passesTheme(it) && passesContentFlags(it)) all.push(i);
  }
  return all;
}

function rerollNearby(){
  if (lastPickIndex==null){ dealOne(); return; }
  const curr = MOVIES[lastPickIndex];
  const c = typeof curr.chaos==="number" ? curr.chaos : 50;
  const pool = neighborsAroundChaos(c, 10, 35, 5);
  if (!pool.length){ err("No nearby picks available with current filters."); return; }
  const idx = pool[Math.floor(Math.random()*pool.length)];
  dealOne(idx);
}

function doubleFeature(){
  if (lastPickIndex==null){ dealOne(); }
  const main = MOVIES[lastPickIndex];
  const mainChaos = typeof main.chaos==="number" ? main.chaos : 50;
  const target = Math.max(0, Math.min(100, 100 - mainChaos)); // inverted

  // progressively widen Â± window; if still nothing, pick the farthest chaos from main
  let pool = neighborsAroundChaos(target, 12, 48, 6);
  if (!pool.length){
    // farthest-from-main fallback
    let bestIdx = null, bestDist = -1;
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const it = MOVIES[i];
      if (!passesTheme(it) || !passesContentFlags(it)) continue;
      const c = typeof it.chaos==="number" ? it.chaos : 50;
      const d = Math.abs(c - mainChaos);
      if (d > bestDist){ bestDist = d; bestIdx = i; }
    }
    if (bestIdx==null){ err("No suitable cleanser with current filters."); return; }
    pool = [bestIdx];
  }

  const idx = pool[Math.floor(Math.random()*pool.length)];
  const item = MOVIES[idx];

  $("#resultB").style.display = "block";
  const poster = $("#posterB");
  poster.src = item.poster ? TMDB_IMG(item.poster, "w500") : "";
  poster.alt = item.title || "poster"; posterLoad(poster);

  setText($("#titleB"), item.title || "Untitled");
  const tag = (item.tagline||"").trim();
  setText($("#taglineInlineB"), tag); show($("#taglineInlineB"), !!tag);

  setText($("#yearB"), item.year ? `Year: ${item.year}` : "");
  const runText = runtimeLabel(item.runtime);
  setText($("#runChipB"), runText); show($("#runChipB"), !!runText);

  const chaos = typeof item.chaos==="number" ? item.chaos : null;
  const chip = $("#chaosChipB"); if (chaos!==null){ setText(chip, `Chaos: ${chaos}`); show(chip, true);} else show(chip, false);

  buildBadges($("#streamBadgesB"), item);
  buildLinksRow($("#linksRowB"), item);
}

/* ---- Histogram ---- */
function buildHistogram(){
  if (!MOVIES.length) return;
  const bins = new Array(10).fill(0);
  for (const m of MOVIES){
    const c = typeof m.chaos==="number" ? m.chaos : 50;
    const b = Math.max(0, Math.min(9, Math.floor(c/10)));
    bins[b]++;
  }
  const max = Math.max(...bins, 1);
  const w = 680, h = 80, pad = 8;
  const barW = (w - pad*2) / bins.length;

  const svg = [];
  svg.push(`<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">`);
  for (let i=0;i<bins.length;i++){
    const x = pad + i*barW + 2;
    const bh = Math.round((bins[i]/max) * (h - 20));
    const y = h - bh - 6;
    svg.push(`<rect x="${x}" y="${y}" width="${barW-4}" height="${bh}" fill="#2a2a2a" rx="3" />`);
  }
  const tx = pad + (CHAOS/100)*(w - pad*2);
  svg.push(`<line x1="${tx}" y1="4" x2="${tx}" y2="${h-4}" stroke="${'#77ffa5'}" stroke-width="2" stroke-dasharray="4 3"/>`);
  svg.push(`<circle id="currDot" cx="-10" cy="${12}" r="4" fill="${'#ff77c7'}" />`);
  svg.push(`</svg>`);
  $("#hist").innerHTML = svg.join("");
  $("#histBox").style.display = "block";
}
function drawHistogramMarker(currentChaos, targetChaos){
  const svg = $("#hist").querySelector("svg"); if (!svg) return;
  const w = 680, pad=8;
  const x = currentChaos!=null ? (pad + (currentChaos/100)*(w - pad*2)) : -10;
  const dot = svg.querySelector("#currDot"); if (dot) dot.setAttribute("cx", String(x));
}

/* ---- Wire up ---- */
$("#deal").addEventListener("click", ()=>dealOne());
$("#reroll").addEventListener("click", rerollNearby);
$("#double").addEventListener("click", doubleFeature);

const cha = $("#cha"), modeText = $("#modeText");
function updateModeLabel(v){
  if (v < 40)      modeText.textContent = "Order â€¢ bias toward low-chaos (newer/tame)";
  else if (v > 60) modeText.textContent = "Chaos â€¢ bias toward high-chaos (older/weird)";
  else             modeText.textContent = "Neutral â€¢ pure shuffle";
}
cha.addEventListener("input", (e)=>{ CHAOS = Number(e.target.value)||50; updateModeLabel(CHAOS); buildHistogram(); });
cha.addEventListener("change", ()=>{ rebuildDeck(); });

function setVar(which){
  VARIETY = which;
  $("#varT").classList.toggle("active", which==="T");
  $("#varM").classList.toggle("active", which==="M");
  $("#varW").classList.toggle("active", which==="W");
  rebuildDeck();
}
$("#varT").onclick = ()=>setVar("T");
$("#varM").onclick = ()=>setVar("M");
$("#varW").onclick = ()=>setVar("W");

function setTheme(which){
  THEME = which;
  $("#thAll").classList.toggle("active", which==="all");
  $("#thWitch").classList.toggle("active", which==="witch");
  $("#thBody").classList.toggle("active", which==="body");
  $("#thFolk").classList.toggle("active", which==="folk");
  $("#thFound").classList.toggle("active", which==="found");
  $("#thNeon").classList.toggle("active", which==="neon");
  rebuildDeck();
}
$("#thAll").onclick  = ()=>setTheme("all");
$("#thWitch").onclick= ()=>setTheme("witch");
$("#thBody").onclick = ()=>setTheme("body");
$("#thFolk").onclick = ()=>setTheme("folk");
$("#thFound").onclick= ()=>setTheme("found");
$("#thNeon").onclick = ()=>setTheme("neon");

function toggleFlag(btn, key){
  btn.classList.toggle("active");
  FILTERS[key] = btn.classList.contains("active");
  rebuildDeck();
}
$("#fNoGore").onclick = (e)=>toggleFlag(e.currentTarget, "noGore");
$("#fNoSV").onclick   = (e)=>toggleFlag(e.currentTarget, "noSV");
$("#fNoKids").onclick = (e)=>toggleFlag(e.currentTarget, "noKids");

loadData();
</script>
</body>
</html>
