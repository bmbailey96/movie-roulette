<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root { color-scheme: light dark; --bg:#0b0b0b; --fg:#f4f4f4; --muted:#9aa0a6; --accent:#77ffa5; --card:#111; --border:#222; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:16px/1.45 -apple-system, system-ui, Segoe UI, Inter, Roboto, sans-serif; }
  .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
  .card { width:min(760px,95vw); border:1px solid var(--border); border-radius:16px; padding:20px; background:var(--card); box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1 { margin:0 0 12px; font-size:20px; letter-spacing:.25px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  button { padding:12px 16px; border-radius:12px; border:0; background:var(--accent); color:#051308; font-weight:800; cursor:pointer; }
  .ghost { background:#1b1b1b; color:var(--fg); border:1px solid #2a2a2a; }
  .grid { display:grid; grid-template-columns:120px 1fr; gap:16px; margin-top:18px; }
  .poster { width:120px; aspect-ratio:2/3; border-radius:10px; object-fit:cover; background:#191919; }
  .title { font-size:22px; font-weight:800; margin:2px 0 4px; }
  .meta { color:var(--muted); margin-bottom:10px; }
  .links a { color:#b5ffd1; text-decoration:none; margin-right:12px; }
  .small { color:var(--muted); font-size:13px; }
  #err { margin-top:10px; color:#ffb3b3; white-space:pre-wrap; display:none; }
  footer { margin-top:14px; color:#7c8a96; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸŽ² Movie Roulette (No Repeats)</h1>

    <div class="row">
      <button id="deal">Deal</button>
      <button id="reset" class="ghost">Reset Deck</button>
      <span class="small">Deck: <span id="left">0</span> â€¢ Total: <span id="total">0</span></span>
    </div>

    <div id="err"></div>

    <div id="result" class="grid" style="display:none;">
      <img id="poster" class="poster" alt="">
      <div>
        <div class="title" id="title"></div>
        <div class="meta" id="year"></div>
        <div class="links">
          <a id="lbLink" target="_blank" rel="noopener">Open on Letterboxd</a>
          <a id="watchLink" target="_blank" rel="noopener">Where to watch</a>
        </div>
      </div>
    </div>

    <footer>This product uses the TMDb API but is not endorsed or certified by TMDb.</footer>
  </div>
</div>

<script>
const TMDB_IMG = (path, size="w500") => path ? `https://image.tmdb.org/t/p/${size}${path}` : "";

const $ = s => document.querySelector(s);
const err = (m) => { const e=$("#err"); e.textContent=m||""; e.style.display=m?"block":"none"; };

// Load full prebuilt list
let MOVIES = [];
let DECK = [];

async function loadData() {
  try {
    const r = await fetch("./movies.json", { cache: "no-store" });
    if (!r.ok) throw new Error("Could not load movies.json");
    MOVIES = await r.json();
    $("#total").textContent = MOVIES.length;
    resetDeck();
  } catch (e) {
    err(e.message || String(e));
  }
}

function shuffleIdx(n){
  const idx = Array.from({length:n}, (_,i)=>i);
  const rnd = new Uint32Array(n); crypto.getRandomValues(rnd);
  for (let i=n-1;i>0;i--){ const j=rnd[i]%(i+1); [idx[i],idx[j]]=[idx[j],idx[i]]; }
  return idx;
}

function resetDeck(){
  DECK = shuffleIdx(MOVIES.length);
  $("#left").textContent = DECK.length;
}

async function deal(){
  err("");
  if (!MOVIES.length) { err("No data yet."); return; }
  if (!DECK.length) resetDeck();
  const idx = DECK.pop();
  $("#left").textContent = DECK.length;

  const item = MOVIES[idx];
  $("#title").textContent = item.title || "Untitled";
  $("#year").textContent = item.year ? `Year: ${item.year}` : "";
  $("#lbLink").href = item.link || "#";
  const poster = $("#poster");
  poster.src = item.poster ? TMDB_IMG(item.poster, "w500") : "";
  poster.alt = item.title || "poster";

  // On-demand provider link (US by default)
  const link = await whereToWatch(item.tmdbId);
  const wl = $("#watchLink");
  wl.href = link || ("https://www.google.com/search?q=" + encodeURIComponent((item.title || "") + " where to watch"));
  wl.textContent = link ? "Where to watch" : "Search streaming";

  $("#result").style.display = "grid";
}

async function whereToWatch(tmdbId, region="US"){
  try {
    if (!tmdbId) return "";
    const url = `https://api.themoviedb.org/3/movie/${tmdbId}/watch/providers?language=en-US&api_key=${encodeURIComponent("{{REPLACE_ME_AT_BUILD}}" )}`;
    // We donâ€™t actually know your key at runtime; weâ€™ll overwrite {{REPLACE_ME_AT_BUILD}} during Action build with a redacted string or leave blank.
    const r = await fetch(url);
    if (!r.ok) return "";
    const data = await r.json();
    const res = data.results?.[region];
    // TMDb returns a link to the JustWatch landing page for the title/region
    return res?.link || "";
  } catch { return ""; }
}

$("#deal").addEventListener("click", deal);
$("#reset").addEventListener("click", resetDeck);
loadData();
</script>
</body>
</html>
