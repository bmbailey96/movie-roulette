<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0b0b; --card:#101010; --fg:#f4f4f4; --muted:#a9b0b6; --border:#222;
    --accent:#77ffa5; --accentFg:#051e11; --ghost:#151515;
    --radius:16px; --shadow:0 10px 34px rgba(0,0,0,.45);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg);
    font:15px/1.45 system-ui, -apple-system, Inter, Segoe UI, Roboto, Arial, sans-serif; }

  /* Full-screen app frame */
  .wrap{ height:100dvh; display:flex; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
  .card{ margin:auto; width:min(860px, 100%); height:calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 12px);
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    display:grid; grid-template-rows:auto auto 1fr auto; gap:8px; padding:10px; overflow:hidden; }

  /* Header */
  header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .appTitle{ font-weight:900; letter-spacing:.2px; font-size:20px; margin:0; }
  .sub{ color:var(--muted); font-size:12px; margin-top:-4px; }
  .deck{ color:#cfe; font-size:12px; padding:6px 10px; border:1px solid #263; border-radius:10px; background:#0f1a14; }

  /* Always-visible mode/bias toolbar */
  .toolbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
  .group{ display:flex; gap:8px; align-items:center; }
  .label{ color:#9ab; font-size:12px; margin-right:2px; }
  .seg{ display:flex; background:#141414; border:1px solid #262626; border-radius:999px; overflow:hidden; }
  .seg button{ background:transparent; border:0; color:#dfffe8; padding:8px 12px; font-weight:900; font-size:13px; cursor:pointer; }
  .seg button.active{ background:#203626; color:#b8ffd1; }

  /* Stage: 2 columns, no page scroll */
  .stage{ min-height:0; display:grid; grid-template-columns:minmax(42%, 44%) 1fr; gap:12px; align-items:start; overflow:hidden; }
  @media (max-width:480px){ .stage{ grid-template-columns:46% 1fr; } }

  .poster{ width:100%; aspect-ratio:2/3; object-fit:cover; border-radius:14px; background:#181818; border:1px solid #1f1f1f; }
  .poster.skeleton{ animation:pulse 1.2s infinite ease-in-out; background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%); background-size:400% 100%; }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}

  /* Info column scrolls if it has to; poster stays big */
  .infoCol{ min-height:0; display:grid; grid-template-rows:auto auto auto 1fr auto; gap:8px; overflow:auto; padding-right:2px; }
  .titleMovie{ font-weight:1000; font-size:22px; margin:0; line-height:1.15; }
  .tagline{ color:#d6e2dd; font-size:14px; margin:0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .micro{ color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:12px; }
  .chip{ background:#141414; border:1px solid #262626; border-radius:999px; padding:6px 10px; font-weight:800; font-size:12px; color:#d8ffe9; }
  .badges{ display:flex; gap:6px; flex-wrap:wrap; }
  .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#171717; color:#bfe; }
  .whyBox{ background:#0f1511; border:1px dashed #294; border-radius:10px; padding:8px; color:#bff5d7; font-size:12px; display:none; }

  /* Links */
  .links{ display:grid; grid-template-columns:1fr; gap:8px; }
  .links a{ display:block; padding:12px; text-align:center; border-radius:12px; text-decoration:none; font-weight:900; font-size:15px; background:#1b1b1b; color:#c0ffd6; border:1px solid #2a2a2a; }

  /* Bottom dock */
  .dock{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; align-items:center; }
  .btn{ appearance:none; border:0; border-radius:14px; padding:14px 12px; font-weight:900; cursor:pointer; font-size:15px; }
  .btn.pri{ background:var(--accent); color:var(--accentFg); }
  .btn.gh{ background:var(--ghost); color:var(--fg); border:1px solid #262626; }

  /* Filters dialog */
  dialog{ border:1px solid var(--border); background:#0f0f0f; color:#fff; border-radius:16px; width:min(560px, 92vw); padding:14px; }
  dialog::backdrop{ background:rgba(0,0,0,.6); }
  .rowFilt{ display:flex; gap:8px; flex-wrap:wrap; }
  .pill{ background:#161616; border:1px solid #2a2a2a; border-radius:999px; padding:8px 10px; font-weight:800; font-size:13px; color:#dfffe8; cursor:pointer; }
  .pill.active{ background:#242a24; color:#b6ffd1; }
  .kicker{ color:#9ab; font-size:12px; }
  .small{ color:#9ab; font-size:11px; }
</style>
</head>
<body>
<div class="wrap">
  <main class="card" id="root">
    <!-- Header -->
    <header>
      <div>
        <h1 class="appTitle">ðŸŽ² Movie Roulette</h1>
        <div class="sub">Thumb-first. No scrolling. Mischief optional.</div>
      </div>
      <div class="deck">Deck: <span id="left">0</span>/<span id="total">0</span></div>
    </header>

    <!-- Always-visible controls -->
    <div class="toolbar">
      <div class="group">
        <span class="label">Mood</span>
        <div class="seg" id="modeSegTop">
          <button data-mode="order">Order</button>
          <button data-mode="mix" class="active">Mix</button>
          <button data-mode="chaos">Chaos</button>
        </div>
      </div>
      <div class="group">
        <span class="label">Bias</span>
        <div class="seg" id="biasSegTop">
          <button data-bias="T" class="active">Tight</button>
          <button data-bias="M">Med</button>
          <button data-bias="W">Wide</button>
        </div>
      </div>
    </div>

    <!-- Stage -->
    <section class="stage" aria-live="polite">
      <img id="poster" class="poster skeleton" referrerpolicy="no-referrer" alt="Movie poster"/>
      <div class="infoCol">
        <h2 class="titleMovie" id="title">â€”</h2>
        <p class="tagline" id="taglineInline" style="display:none;"></p>
        <div class="micro">
          <span id="year"></span>
          <span id="runChip" class="chip" style="display:none;"></span>
          <span id="chaosChip" class="chip" style="display:none;"></span>
        </div>
        <div class="badges" id="streamBadges" style="display:none;"></div>
        <div class="whyBox" id="whyBox"></div>
        <div class="links" id="linksRow"></div>
        <div class="small" id="err" role="alert" aria-live="polite"></div>
      </div>
    </section>

    <!-- Bottom dock -->
    <nav class="dock">
      <button id="deal" class="btn pri">Deal</button>
      <button id="reroll" class="btn gh">Re-roll</button>
      <button id="double" class="btn gh">Double</button>
      <button id="openFilters" class="btn gh">Filters</button>
    </nav>
  </main>
</div>

<!-- Filters (Themes + Content only) -->
<dialog id="filtersDlg">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
    <strong>Filters</strong><div class="kicker" id="deckCountMini">Deck: 0</div>
  </div>

  <div class="kicker">Themes</div>
  <div class="rowFilt" style="margin-bottom:8px;">
    <div class="pill active" id="thAll">All</div>
    <div class="pill" id="thWitch">Witchy</div>
    <div class="pill" id="thBody">Body</div>
    <div class="pill" id="thFolk">Folk</div>
    <div class="pill" id="thFound">Found</div>
    <div class="pill" id="thNeon">Neon</div>
  </div>

  <div class="kicker">Content</div>
  <div class="rowFilt" style="margin-bottom:12px;">
    <div class="pill" id="fNoGore">No gore</div>
    <div class="pill" id="fNoSV">No sexual violence</div>
    <div class="pill" id="fNoKids">No kids-in-peril</div>
  </div>

  <div class="rowFilt" style="justify-content:flex-end;">
    <button class="btn gh" id="resetAll">Reset</button>
    <button class="btn pri" id="closeFilters">Close</button>
  </div>
</dialog>

<script>
/* ====== CONFIG ====== */
const MY_SERVICES = new Set(["Netflix","Amazon Prime Video","Hulu","Max","Paramount+","Apple TV+","Tubi TV"]);
const TMDB_IMG = "https://image.tmdb.org/t/p";

/* ====== UTIL ====== */
const $ = s => document.querySelector(s);
function setUIError(m=""){ const e=$("#err"); e.textContent=m; e.style.color=m?"#ffb3b3":"#9ab"; }

/* Hardened poster loader */
function posterURL(path, size="w500"){
  if (!path) return "";
  const s = String(path).trim();
  if (!s || s==="null" || s==="undefined") return "";
  if (s.startsWith("http://")) return s.replace("http://","https://");
  if (s.startsWith("https://")) return s;
  const clean = s.startsWith("/") ? s : "/"+s;
  return `${TMDB_IMG}/${size}${clean}`;
}
function setPoster(imgEl, posterPath, title){
  const sizes = ["w500","w780","original","w342"];
  let i = 0;
  function tryNext(){
    const u = posterURL(posterPath, sizes[i]);
    if (!u){ setFallback(); return; }
    imgEl.src = u;
  }
  function setFallback(){
    imgEl.src = `data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 900"><rect width="100%" height="100%" fill="#141414"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#5a5a5a" font-family="system-ui, -apple-system, Segoe UI, Roboto" font-size="28">NO POSTER</text></svg>')}`;
  }
  imgEl.alt = title || "poster";
  imgEl.classList.add("skeleton");
  imgEl.onerror = () => { i++; (i < sizes.length) ? tryNext() : (setFallback(), imgEl.classList.remove("skeleton")); };
  imgEl.onload  = () => imgEl.classList.remove("skeleton");
  tryNext();
}

/* ====== STATE ====== */
let MOVIES=[], DECK=[];
let MODE="mix";   // order | mix | chaos
let VARIETY="T";  // T | M | W
let THEME="all";
let FILTERS={ noGore:false, noSV:false, noKids:false };
let lastPickIndex=null;

/* ====== DATA LOAD ====== */
async function loadData(){
  try{
    const r = await fetch("./movies.json?v="+Date.now(), {cache:"no-store"});
    const txt = await r.text(); if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,180)}`);
    const raw = JSON.parse(txt);
    MOVIES = raw.map(x => ({
      ...x,
      poster: x.poster || x.poster_path || "",
      chaos: (typeof x.chaos === "number") ? x.chaos
            : (x.Chaos!==undefined && x.Chaos!=="") ? Number(x.Chaos) : null
    }));
    $("#total").textContent = MOVIES.length;
    rebuildDeck();
  }catch(e){
    setUIError("Could not load movies.json. "+(e.message||e));
    console.error(e);
  }
}

/* ====== FILTER LOGIC ====== */
function providerMatches(p){
  if (!p?.name) return false;
  const n = String(p.name).trim();
  if (MY_SERVICES.has(n)) return true;
  if (n === "HBO Max" && MY_SERVICES.has("Max")) return true;
  if (n === "Max" && MY_SERVICES.has("HBO Max")) return true;
  return false;
}
function availabilityNames(item){
  const prov = Array.isArray(item.providers) ? item.providers : [];
  const names=[]; const seen=new Set();
  for (const p of prov){ if (providerMatches(p)){ const nm = String(p.name).trim(); if (!seen.has(nm)){ seen.add(nm); names.push(nm); } } }
  return names;
}
function buildBadges(container, item){
  const names = availabilityNames(item);
  container.innerHTML = "";
  if (names.length){
    for (const n of names){ const s=document.createElement("span"); s.className="badge"; s.textContent=n; container.appendChild(s); }
    container.style.display="";
  } else container.style.display="none";
}
function passesTheme(item){
  const f = item.flags || {};
  if (THEME==="all") return true;
  if (THEME==="witch") return f.theme_witchy;
  if (THEME==="body")  return f.theme_body_horror;
  if (THEME==="folk")  return f.theme_folk;
  if (THEME==="found") return f.theme_found_footage;
  if (THEME==="neon")  return f.theme_neon;
  return true;
}
function passesContent(item){
  const f=item.flags||{};
  if (FILTERS.noGore && f.extreme_gore) return false;
  if (FILTERS.noSV && f.sexual_violence) return false;
  if (FILTERS.noKids && f.kids_in_peril) return false;
  return !item.unreleased_error;
}

/* ====== CHAOS TARGETING ====== */
function chaosTarget(){ return MODE==="order" ? 15 : MODE==="chaos" ? 85 : 50; }
function band(){ return VARIETY==="T"?7: VARIETY==="M"?15:30; }

/* ====== DECK (never empty) ====== */
function rebuildDeck(){
  try{
    if (!MOVIES.length) return;
    const target = chaosTarget();
    let b = band();

    let cands = MOVIES.map((m,i)=>({m,i}))
      .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);

    while (!cands.length && b <= 60){
      b+=10;
      cands = MOVIES.map((m,i)=>({m,i}))
        .filter(({m}) => passesTheme(m) && passesContent(m) && (typeof m.chaos==="number") && Math.abs(m.chaos - target) <= b);
    }
    if (!cands.length){
      cands = MOVIES.map((m,i)=>({m,i}))
        .filter(({m}) => passesTheme(m) && passesContent(m));
    }
    if (!cands.length){ cands = MOVIES.map((m,i)=>({m,i})); }

    const deck = cands.map(x=>x.i);
    try{
      const rnd = new Uint32Array(deck.length);
      (crypto?.getRandomValues ? crypto.getRandomValues(rnd) : rnd.fill(0));
      for (let i=deck.length-1;i>0;i--){
        const j = (crypto?.getRandomValues ? rnd[i]%(i+1) : Math.floor(Math.random()*(i+1)));
        [deck[i],deck[j]]=[deck[j],deck[i]];
      }
    }catch(_){
      for (let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
    }
    DECK = deck;
    $("#left").textContent = DECK.length;
    $("#deckCountMini").textContent = "Deck: " + DECK.length;
  }catch(e){
    console.error(e);
    setUIError("Deck build error: "+e.message);
    DECK = MOVIES.map((_,i)=>i).sort(()=>Math.random()-0.5);
    $("#left").textContent = DECK.length;
    $("#deckCountMini").textContent = "Deck: " + DECK.length;
  }
}

/* ====== RENDER ====== */
function setText(el, t){ el.textContent=t; }
function show(el, on){ el.style.display = on ? "" : "none"; }

function links(container, item){
  container.innerHTML = "";
  const lb=document.createElement("a");
  lb.textContent="Open on Letterboxd"; lb.href=item.link||"#"; lb.target="_blank"; lb.rel="noopener";
  container.appendChild(lb);

  const names = availabilityNames(item);
  if (!names.length){
    const q=encodeURIComponent(`${item.title} full movie site:archive.org OR site:youtube.com OR torrent`);
    const s=document.createElement("a");
    s.textContent="Search elsewhere"; s.href="https://www.google.com/search?q="+q; s.target="_blank"; s.rel="noopener";
    container.appendChild(s);
  }
}

function render(item){
  try{
    setPoster($("#poster"), item.poster, item.title);
    setText($("#title"), item.title||"Untitled");
    const tg=(item.tagline||"").trim(); setText($("#taglineInline"), tg); show($("#taglineInline"), !!tg);
    const metaErr = item.unreleased_error ? ` â€” ${item.unreleased_error}` : "";
    setText($("#year"), item.year ? `Year: ${item.year}${metaErr}` : metaErr);
    const run=item.runtime?`${item.runtime} min`:""; setText($("#runChip"), run); show($("#runChip"), !!run);
    const c=item.chaos; if (typeof c==="number"){ setText($("#chaosChip"), `Chaos: ${c}`); show($("#chaosChip"),true);} else show($("#chaosChip"),false);
    buildBadges($("#streamBadges"), item);
    const why=(item.chaos_reason||"").trim(); const w=$("#whyBox");
    if (why){ w.textContent=why; w.style.display="block"; } else w.style.display="none";
    links($("#linksRow"), item);
    setUIError("");
  }catch(e){
    console.error(e);
    setUIError("Render error: "+e.message);
  }
}

/* ====== PICKING ====== */
function safeDealIndex(){
  if (!DECK.length) rebuildDeck();
  let idx = DECK.pop();
  if (idx==null || idx===undefined || isNaN(idx)){
    idx = Math.floor(Math.random()*Math.max(1, MOVIES.length));
  }
  return idx;
}
function dealOne(){
  try{
    if (!MOVIES.length){ setUIError("Data not loaded yet."); return; }
    const idx = safeDealIndex();
    lastPickIndex = idx;
    $("#left").textContent = Math.max(0, DECK.length);
    render(MOVIES[idx]);
  }catch(e){
    console.error(e);
    setUIError("Deal error: "+e.message);
  }
}
function neighbors(target,initial,max,step){
  for (let r=initial;r<=max;r+=step){
    const pool=[];
    for (let i=0;i<MOVIES.length;i++){
      if (i===lastPickIndex) continue;
      const m=MOVIES[i]; if (!passesTheme(m) || !passesContent(m)) continue;
      const c=typeof m.chaos==="number"?m.chaos:50;
      if (Math.abs(c-target)<=r) pool.push(i);
    }
    if (pool.length) return pool;
  }
  return MOVIES.map((m,i)=>({m,i})).filter(({m})=>passesTheme(m)&&passesContent(m)).map(x=>x.i);
}
function rerollNearby(){
  try{
    if (lastPickIndex==null){ dealOne(); return; }
    const curr=MOVIES[lastPickIndex], c=typeof curr.chaos==="number"?curr.chaos:50;
    const pool=neighbors(c,10,40,5);
    if (!pool.length){ setUIError("No nearby picks with current filters."); return; }
    const idx = pool[Math.floor(Math.random()*pool.length)];
    lastPickIndex = idx;
    render(MOVIES[idx]);
  }catch(e){
    console.error(e);
    setUIError("Re-roll error: "+e.message);
  }
}
function doubleFeature(){
  try{
    if (lastPickIndex==null){ dealOne(); return; }
    const main=MOVIES[lastPickIndex], mc=typeof main.chaos==="number"?main.chaos:50;
    const target=Math.max(0, Math.min(100, 100-mc)); // opposite energy
    let pool=neighbors(target,12,48,6);
    if (!pool.length){
      let best=-1, idx=null;
      for (let i=0;i<MOVIES.length;i++){
        if (i===lastPickIndex) continue;
        const m=MOVIES[i]; if (!passesTheme(m)||!passesContent(m)) continue;
        const d=Math.abs((m.chaos??50)-mc); if (d>best){ best=d; idx=i; }
      }
      if (idx==null){ setUIError("No suitable cleanser with current filters."); return; }
      pool=[idx];
    }
    const idx = pool[Math.floor(Math.random()*pool.length)];
    lastPickIndex = idx;
    render(MOVIES[idx]);
  }catch(e){
    console.error(e);
    setUIError("Double error: "+e.message);
  }
}

/* ====== WIRES ====== */
$("#deal").onclick = dealOne;
$("#reroll").onclick = rerollNearby;
$("#double").onclick = doubleFeature;

/* Filters dialog (themes/content only) */
const dlg=$("#filtersDlg");
$("#openFilters").onclick = ()=>dlg.showModal();
$("#closeFilters").onclick = ()=>dlg.close();
$("#resetAll").onclick = ()=>{
  MODE="mix"; VARIETY="T"; THEME="all"; FILTERS={noGore:false,noSV:false,noKids:false};
  // reset top toggles
  [...$("#modeSegTop").children].forEach(b=>b.classList.remove("active")); $("#modeSegTop").children[1].classList.add("active");
  [...$("#biasSegTop").children].forEach(b=>b.classList.remove("active")); $("#biasSegTop").children[0].classList.add("active");
  // reset dialog chips
  ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  $("#thAll").classList.add("active");
  ["fNoGore","fNoSV","fNoKids"].forEach(id=>$("#"+id).classList.remove("active"));
  rebuildDeck(); dlg.close();
};
/* Mode/Bias toggles (top bar) */
$("#modeSegTop").addEventListener("click",(e)=>{ if(e.target.tagName!=="BUTTON")return;
  MODE=e.target.dataset.mode; [...$("#modeSegTop").children].forEach(b=>b.classList.toggle("active",b===e.target)); rebuildDeck(); });
$("#biasSegTop").addEventListener("click",(e)=>{ if(e.target.tagName!=="BUTTON")return;
  VARIETY=e.target.dataset.bias; [...$("#biasSegTop").children].forEach(b=>b.classList.toggle("active",b===e.target)); rebuildDeck(); });
/* Themes */
function setTheme(w){ THEME=w; ["thAll","thWitch","thBody","thFolk","thFound","thNeon"].forEach(id=>$("#"+id).classList.remove("active"));
  const map={all:"thAll",witch:"thWitch",body:"thBody",folk:"thFolk",found:"thFound",neon:"thNeon"}; $("#"+map[w]).classList.add("active"); rebuildDeck(); }
$("#thAll").onclick=()=>setTheme("all"); $("#thWitch").onclick=()=>setTheme("witch"); $("#thBody").onclick=()=>setTheme("body");
$("#thFolk").onclick=()=>setTheme("folk"); $("#thFound").onclick=()=>setTheme("found"); $("#thNeon").onclick=()=>setTheme("neon");
/* Content toggles */
$("#fNoGore").onclick =()=>{ FILTERS.noGore=!FILTERS.noGore; $("#fNoGore").classList.toggle("active",FILTERS.noGore); rebuildDeck(); };
$("#fNoSV").onclick   =()=>{ FILTERS.noSV=!FILTERS.noSV; $("#fNoSV").classList.toggle("active",FILTERS.noSV); rebuildDeck(); };
$("#fNoKids").onclick =()=>{ FILTERS.noKids=!FILTERS.noKids; $("#fNoKids").classList.toggle("active",FILTERS.noKids); rebuildDeck(); };

/* Start */
loadData();
</script>
</body>
</html>
