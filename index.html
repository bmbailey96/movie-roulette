<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Movie Roulette</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0b0b; --card:#111; --fg:#f4f4f4; --muted:#9aa0a6; --border:#232323; --accent:#77ffa5;
    --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.45);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 -apple-system, system-ui, Inter, Segoe UI, Roboto, sans-serif; }
  .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left)); }
  .card{ width:100%; max-width:560px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }

  h1{ margin:0 0 8px; font-size:20px; letter-spacing:.2px; }
  .muted{ color:var(--muted); font-size:13px; }

  .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
  .controls .spacer{ flex:1 1 auto; }
  button{
    appearance:none; border:0; border-radius:12px; padding:14px 16px; font-weight:800; cursor:pointer;
    background:var(--accent); color:#05200f; flex:1 0 130px; font-size:16px;
  }
  .ghost{ background:#1b1b1b; color:var(--fg); border:1px solid #2a2a2a; }
  .count{ align-self:center; font-weight:600; padding:6px 10px; border:1px solid #222; border-radius:10px; }

  /* Order ‚Üî Chaos slider */
  .chaos{ margin-top:10px; display:flex; gap:10px; align-items:center; flex-direction:column; }
  .sliderrow{ display:flex; gap:10px; align-items:center; width:100%; }
  .sliderrow input[type="range"]{ flex:1 1 auto; appearance:none; height:34px; background:transparent; }
  .sliderrow input[type="range"]::-webkit-slider-runnable-track{ height:6px; background:#1b1b1b; border:1px solid #2a2a2a; border-radius:999px; }
  .sliderrow input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:22px; height:22px; margin-top:-8px; border-radius:50%;
    background:var(--accent); border:2px solid #083; box-shadow:0 1px 4px rgba(0,0,0,.35);
  }
  .chaos .val{ width:56px; text-align:right; color:#c4cbd2; font-variant-numeric: tabular-nums; }
  .labels{ display:flex; justify-content:space-between; gap:10px; width:100%; margin-top:2px; }
  .labels label{ font-size:12px; color:var(--muted); }

  .result{ display:none; margin-top:14px; }
  .poster{
    width:100%; max-width:420px; margin:0 auto 12px; display:block;
    aspect-ratio:2/3; object-fit:cover; border-radius:14px; background:#181818;
  }
  .title{ font-size:24px; font-weight:900; margin:2px 0 2px; word-wrap:break-word; }
  .tagline-inline{ color:#c4cbd2; font-size:15px; margin:0 0 8px; }
  .meta{ color:var(--muted); margin-bottom:10px; }

  .links{ display:flex; gap:10px; flex-wrap:wrap; }
  .links a{
    display:inline-block; padding:12px 14px; border-radius:12px; text-decoration:none; font-weight:700; font-size:15px;
    background:#1b1b1b; color:#c0ffd6; border:1px solid #2a2a2a; flex:1 1 220px; text-align:center;
  }

  #err{ margin-top:10px; color:#ffb3b3; white-space:pre-wrap; }
  .skeleton{
    animation: pulse 1.2s infinite ease-in-out;
    background: linear-gradient(90deg,#141414 25%,#1a1a1a 37%,#141414 63%);
    background-size:400% 100%;
  }
  @keyframes pulse{0%{background-position:100% 0}100%{background-position:-100% 0}}

  @media (min-width:700px){
    .title{ font-size:26px; }
    button{ flex:0 0 auto }
    .links a{ flex:0 0 auto }
  }
</style>
</head>
<body>
<div class="wrap">
  <main class="card" role="main">
    <h1>üé≤ Movie Roulette</h1>
    <div class="muted">Tap ‚ÄúDeal‚Äù for a random pick. No repeats until the deck is spent.</div>

    <div class="controls" aria-label="controls">
      <button id="deal">Deal</button>
      <button id="reset" class="ghost">Reset Deck</button>
      <div class="spacer"></div>
      <div class="count muted">Deck: <span id="left">0</span> ‚Ä¢ Total: <span id="total">0</span></div>
    </div>

    <!-- Order ‚Üî Chaos slider -->
    <div class="chaos" aria-label="order chaos control">
      <div class="sliderrow">
        <input id="cha" type="range" min="0" max="100" step="1" value="50" />
        <div class="val" id="chaVal">50</div>
      </div>
      <div class="labels">
        <label>Order (newer / tame)</label>
        <label>Chaos (older / weird)</label>
      </div>
    </div>

    <div id="err" role="alert" aria-live="polite"></div>

    <section id="result" class="result" aria-live="polite">
      <img id="poster" class="poster skeleton" alt="Movie poster" />
      <div class="title" id="title">Loading‚Ä¶</div>
      <div class="tagline-inline" id="taglineInline" style="display:none;"></div>
      <div class="meta" id="year"></div>

      <div class="links">
        <a id="lbLink" target="_blank" rel="noopener">Open on Letterboxd</a>
        <a id="watchLink" target="_blank" rel="noopener">Where to watch</a>
      </div>
    </section>

    <p class="muted" style="margin-top:14px;">Tip: Add to Home Screen from Safari‚Äôs share menu for full-screen app mode.</p>
    <p class="muted" style="margin-top:6px; font-size:12px;">This product uses the TMDb API but is not endorsed or certified by TMDb.</p>
  </main>
</div>

<script>
const $ = s => document.querySelector(s);
const err = (m="") => { const e=$("#err"); e.textContent=m; e.style.display = m ? "block" : "none"; };
const TMDB_IMG = (path, size="w500") => path ? `https://image.tmdb.org/t/p/${size}${path}` : "";

let MOVIES = [];
let DECK = [];
let CHAOS = 50; // 0..100; 50 = neutral

async function loadData() {
  try {
    const r = await fetch("./movies.json?v=" + Date.now(), { cache: "no-store" });
    const txt = await r.text();
    if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt.slice(0,180)}`);
    MOVIES = JSON.parse(txt);
    $("#total").textContent = MOVIES.length;
    rebuildDeck();
  } catch (e) {
    err("Could not load movies.json.\n" + (e.message || e));
  }
}

/* ======== Order vs Chaos weighting (v2) ======== */
// Chaos side favors OLD + WEIRD; Order side favors NEW + TAME.
// Word-boundary matching, normalization, and anti-bias terms.

const WEIRD_WORDS = [
  "demon","witch","blood","gore","mutant","possession","alien","apocalypse","cult","curse","cursed",
  "nightmare","corpse","zombie","kaiju","satan","hell","freak","monster","vampire","ghost","necro",
  "tentacle","slime","meltdown","surreal","weird","haunted","killer","cannibal","driller","scream",
  "beast","grotesque","fever","evil","ritual","occult","inferno"
];
const TAME_WORDS = [
  "drama","biopic","documentary","romance","comedy","adventure","family","animation","biography",
  "sports","sport","music","musical","histor","true story","inspired by","based on"
];

function countMatches(words, text){
  const t = (text||"").toLowerCase();
  let c = 0;
  for (const w of words){
    const re = new RegExp(`\\b${w.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}\\b`,"i");
    if (re.test(t)) c++;
  }
  return c;
}
function scoreWeird(item){
  const c = countMatches(WEIRD_WORDS, `${item.title} ${item.tagline||""}`);
  return Math.min(1.6, Math.log2(1 + c));
}
function scoreTame(item){
  const c = countMatches(TAME_WORDS, `${item.title} ${item.tagline||""}`);
  return Math.min(1.3, Math.log2(1 + c)) || 0;
}
function scoreOld(year){
  const y = Number(year); if (!y) return 0;
  const age = Math.max(0, 2025 - y);
  return Math.min(2.0, age / 25); // 25y -> 1.0, 50y -> 2.0
}
function scoreNew(year){
  const y = Number(year); if (!y) return 0;
  return Math.min(2.0, Math.max(0, (y - 2005) / 10)); // 2005->0, 2015->1, 2025->2
}
// Normalize list to ~0..1 via z-score squish -> sigmoid
function normalize(vals){
  const n = Math.max(1, vals.length);
  const mean = vals.reduce((a,b)=>a+b,0)/n;
  const sd = Math.sqrt(vals.reduce((a,b)=>a+(b-mean)*(b-mean),0)/n) || 1;
  return vals.map(v => 1/(1+Math.exp(-((v-mean)/sd))));
}

function rebuildDeck(){
  if (!MOVIES.length) return;

  const bias = (CHAOS - 50) / 50; // -1 .. +1

  // precompute + normalize
  const rawOld = MOVIES.map(m => scoreOld(m.year));
  const rawNew = MOVIES.map(m => scoreNew(m.year));
  const rawWeird = MOVIES.map(m => scoreWeird(m));
  const rawTame = MOVIES.map(m => scoreTame(m));

  const nOld = normalize(rawOld);
  const nNew = normalize(rawNew);
  const nWeird = normalize(rawWeird);
  const nTame = normalize(rawTame);

  const bucket = [];

  for (let i=0;i<MOVIES.length;i++){
    const old = nOld[i], nw = nNew[i], wd = nWeird[i], tm = nTame[i];

    let weight = 1; // base
    if (bias >= 0){
      // CHAOS: reward old + weird; penalize new + tame
      const k = bias; // 0..1
      const chaosScore = 0.6*old + 0.8*wd;
      const newTame = 0.6*nw + 0.6*tm;
      weight += k * 2.0 * chaosScore;
      weight -= k * 1.2 * newTame;
    } else {
      // ORDER: reward new + tame; penalize old + weird
      const k = -bias; // 0..1
      const orderScore = 0.7*nw + 0.7*tm;
      const oldWeird = 0.7*old + 0.9*wd;
      weight += k * 2.0 * orderScore;
      weight -= k * 1.2 * oldWeird;
    }

    // clamp & discretize
    weight = Math.max(0.2, Math.min(3.5, weight));
    const times = Math.max(1, Math.min(10, Math.round(weight * 3))); // 1..10 copies
    for (let t=0;t<times;t++) bucket.push(i);
  }

  // shuffle bucket
  const rnd = new Uint32Array(bucket.length); crypto.getRandomValues(rnd);
  for (let i=bucket.length-1;i>0;i--){ const j=rnd[i]%(i+1); [bucket[i],bucket[j]]=[bucket[j],bucket[i]]; }

  // collapse to no-repeat order by first occurrence
  const seen = new Set(); const deck = [];
  for (const idx of bucket){ if (!seen.has(idx)){ seen.add(idx); deck.push(idx); } }
  DECK = deck;
  $("#left").textContent = DECK.length;
}

function resetDeck(){ rebuildDeck(); }

/* ======== Deal one ======== */
async function deal(){
  err("");
  if (!MOVIES.length){ err("Data not loaded yet."); return; }
  if (!DECK.length) rebuildDeck();
  const idx = DECK.pop();
  $("#left").textContent = DECK.length;

  const item = MOVIES[idx];
  const res = $("#result");
  const poster = $("#poster");
  res.style.display = "block";
  poster.classList.add("skeleton");

  $("#title").textContent = item.title || "Untitled";

  const tagline = (item.tagline && String(item.tagline).trim()) || "";
  const tInline = $("#taglineInline");
  if (tagline) { tInline.textContent = tagline; tInline.style.display = "block"; }
  else { tInline.textContent = ""; tInline.style.display = "none"; }

  $("#year").textContent = item.year ? `Year: ${item.year}` : "";
  $("#lbLink").href = item.link || "#";

  poster.alt = item.title || "poster";
  poster.src = item.poster ? TMDB_IMG(item.poster, "w500") : "";
  poster.onload = poster.onerror = () => poster.classList.remove("skeleton");

  if (item.justwatch) {
    $("#watchLink").href = item.justwatch;
    $("#watchLink").textContent = "Where to watch";
  } else {
    $("#watchLink").href = "https://www.google.com/search?q=" + encodeURIComponent((item.title||"") + " where to watch");
    $("#watchLink").textContent = "Search streaming";
  }
}

/* ======== Wire up ======== */
$("#deal").addEventListener("click", deal);
$("#reset").addEventListener("click", resetDeck);
$("#cha").addEventListener("input", (e)=>{
  CHAOS = Number(e.target.value) || 50;
  $("#chaVal").textContent = CHAOS;
});
$("#cha").addEventListener("change", ()=>{ rebuildDeck(); }); // rebuild on release

// (Optional) press "D" to toggle console debug logs for picks
let DEBUG_ON = false;
window.addEventListener("keydown",(e)=>{ if (e.key.toLowerCase()==="d"){ DEBUG_ON=!DEBUG_ON; console.log("Debug:", DEBUG_ON); }});

loadData();
</script>
</body>
</html>
